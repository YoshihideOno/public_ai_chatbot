# 開発ガイドライン

本ドキュメントでは、RAG AIプラットフォームの開発におけるガイドラインを説明します。

## 目次

- [コーディング規約](#コーディング規約)
- [ブランチ戦略](#ブランチ戦略)
- [コミット規約](#コミット規約)
- [コードレビュープロセス](#コードレビュープロセス)
- [テスト戦略](#テスト戦略)
- [ドキュメント作成](#ドキュメント作成)

---

## コーディング規約

### Python (FastAPI)

#### 基本原則

- **PEP 8準拠**: Pythonの標準コーディング規約に準拠
- **型ヒント必須**: すべての関数・メソッドに型ヒントを記述
- **関数の長さ**: 最大50行以内
- **クラスの長さ**: 最大300行以内
- **エラーハンドリング**: 必ず実装
- **ログ出力**: 構造化ログ（JSON形式）を使用
- **非同期処理**: 積極的に使用

#### ファイル構造

```python
"""
ファイルの目的や役割などを日本語で記述

このファイルはXXX機能を提供します。
主な機能:
- 機能1
- 機能2
"""

from typing import List, Dict, Optional
from sqlalchemy.ext.asyncio import AsyncSession

# インポート順序:
# 1. 標準ライブラリ
# 2. サードパーティライブラリ
# 3. ローカルアプリケーション/ライブラリ固有のインポート


class ExampleService:
    """
    サービスクラス
    
    このクラスはXXX機能を提供します。
    """
    
    def __init__(self, db: AsyncSession):
        """
        初期化
        
        引数:
            db: データベースセッション
        """
        self.db = db
    
    async def example_method(
        self, 
        param1: str, 
        param2: Optional[int] = None
    ) -> Dict[str, Any]:
        """
        メソッドの説明
        
        引数:
            param1: パラメータ1の説明
            param2: パラメータ2の説明（オプション）
        
        戻り値:
            Dict[str, Any]: 戻り値の説明
        
        例外:
            ValueError: エラー条件の説明
        """
        try:
            # 処理内容
            pass
        except Exception as e:
            logger.error(f"エラーメッセージ: {str(e)}", exc_info=True)
            raise
```

#### 命名規則

- **ファイル名**: `snake_case`（例: `user_service.py`）
- **変数名**: `snake_case`（例: `user_id`, `tenant_name`）
- **定数名**: `UPPER_SNAKE_CASE`（例: `MAX_RETRY_COUNT`）
- **クラス名**: `PascalCase`（例: `UserService`, `TenantRepository`）
- **関数名**: 動詞 + 名詞（例: `get_user`, `create_tenant`）

#### エラーハンドリング

```python
# 良い例
try:
    result = await some_operation()
    return result
except SpecificError as e:
    logger.error(f"エラー発生: {str(e)}", exc_info=True)
    raise CustomException("エラーメッセージ") from e
except Exception as e:
    logger.error(f"予期しないエラー: {str(e)}", exc_info=True)
    raise

# 悪い例
try:
    result = await some_operation()
    return result
except:
    pass  # 例外を握りつぶさない
```

#### ログ出力

```python
from app.utils.logging import logger, BusinessLogger, ErrorLogger

# 構造化ログ
logger.info("処理開始", extra={
    "user_id": user_id,
    "tenant_id": tenant_id,
    "operation": "create_user"
})

# ビジネスログ
BusinessLogger.log_user_action(
    user_id=str(user.id),
    action="create_tenant",
    resource_type="tenant",
    tenant_id=str(tenant.id)
)

# エラーログ
ErrorLogger.log_exception(
    exception=e,
    context={"operation": "file_upload", "file_id": file_id}
)
```

### TypeScript (Next.js)

#### 基本原則

- **strict mode**: TypeScriptのstrict modeを使用
- **関数の長さ**: 最大30行以内
- **コンポーネントの長さ**: 最大200行以内
- **Propsの型定義**: 必ず記述
- **エラーバウンダリ**: 実装
- **アクセシビリティ**: 考慮

#### ファイル構造

```typescript
/**
 * コンポーネントの説明
 * 
 * このコンポーネントはXXX機能を提供します。
 */

'use client';

import { useState, useEffect } from 'react';
import { Button } from '@/components/ui/button';

interface ComponentProps {
  /** プロパティ1の説明 */
  prop1: string;
  /** プロパティ2の説明（オプション） */
  prop2?: number;
  /** コールバック関数 */
  onSubmit: (data: FormData) => void;
}

export function Component({ prop1, prop2, onSubmit }: ComponentProps) {
  const [state, setState] = useState<string>('');

  useEffect(() => {
    // 副作用処理
  }, [prop1]);

  const handleSubmit = () => {
    try {
      onSubmit(formData);
    } catch (error) {
      console.error('エラー:', error);
    }
  };

  return (
    <div>
      {/* JSX */}
    </div>
  );
}
```

#### 命名規則

- **ファイル名**: `PascalCase.tsx`（コンポーネント）、`camelCase.ts`（ユーティリティ）
- **変数名**: `camelCase`（例: `userId`, `tenantName`）
- **定数名**: `UPPER_SNAKE_CASE`（例: `MAX_RETRY_COUNT`）
- **コンポーネント名**: `PascalCase`（例: `UserForm`, `TenantCard`）
- **関数名**: `camelCase`（例: `getUser`, `createTenant`）

#### 型定義

```typescript
// インターフェース定義
interface User {
  id: string;
  email: string;
  name: string;
  role: UserRole;
}

// 型エイリアス
type UserRole = 'ADMIN' | 'OPERATOR' | 'USER';

// ユニオン型
type Status = 'active' | 'inactive' | 'pending';
```

---

## ブランチ戦略

### ブランチ命名規則

- **機能追加**: `feat/機能名`（例: `feat/user-authentication`）
- **バグ修正**: `fix/問題の説明`（例: `fix/login-error`）
- **ドキュメント**: `docs/内容`（例: `docs/api-reference`）
- **リファクタリング**: `refactor/対象`（例: `refactor/user-service`）
- **テスト**: `test/対象`（例: `test/user-service`）

### ブランチフロー

```
main (本番環境)
  ↑
staging (ステージング環境)
  ↑
develop (開発環境)
  ↑
feat/xxx, fix/xxx, etc. (機能ブランチ)
```

### ブランチ作成手順

1. `develop` ブランチから新しいブランチを作成
2. 機能開発・修正を実施
3. テストを追加・更新
4. コミット・プッシュ
5. Pull Requestを作成

---

## コミット規約

### コミットメッセージ形式

```
<type>(<scope>): <subject>

<body>

<footer>
```

### Type（必須）

- `feat`: 新機能
- `fix`: バグ修正
- `docs`: ドキュメント
- `style`: フォーマット（コードの動作に影響しない変更）
- `refactor`: リファクタリング
- `test`: テスト追加・修正
- `chore`: その他（ビルド、依存関係等）

### Scope（任意）

影響範囲を指定（例: `auth`, `api`, `frontend`, `database`）

### Subject（必須）

- 50文字以内
- 動詞で始める（例: `追加`, `修正`, `削除`）
- 句読点を使用しない

### 例

```
feat(auth): JWT認証機能を実装

- アクセストークンとリフレッシュトークンの生成
- トークン検証ミドルウェアの追加
- ログイン・ログアウトエンドポイントの実装

Closes #123
```

```
fix(api): ファイルアップロード時のエラーハンドリングを修正

ファイルサイズが大きい場合のタイムアウトエラーを修正
```

---

## コードレビュープロセス

### Pull Request作成

1. **タイトル**: コミットメッセージと同様の形式
2. **説明**: 
   - 変更内容の概要
   - 関連するIssue番号
   - テスト結果
   - スクリーンショット（UI変更の場合）

### レビューチェックリスト

#### コード品質

- [ ] コーディング規約に準拠しているか
- [ ] 型ヒントが適切に記述されているか
- [ ] エラーハンドリングが実装されているか
- [ ] ログ出力が適切か
- [ ] コメントが適切に記述されているか

#### セキュリティ

- [ ] 認証・認可が適切に実装されているか
- [ ] 入力バリデーションが実装されているか
- [ ] SQLインジェクション対策がされているか
- [ ] XSS対策がされているか

#### テスト

- [ ] 単体テストが追加・更新されているか
- [ ] テストが通過しているか
- [ ] エッジケースが考慮されているか

#### パフォーマンス

- [ ] N+1問題が回避されているか
- [ ] 不要なクエリが実行されていないか
- [ ] キャッシュが適切に使用されているか

### レビューコメント

- **必須修正**: マージ前に修正が必要
- **推奨修正**: マージ後でも良いが、修正を推奨
- **質問**: 理解を深めるための質問

---

## テスト戦略

### テストの種類

1. **単体テスト**: 関数・メソッド単位のテスト
2. **統合テスト**: 複数コンポーネントの連携テスト
3. **E2Eテスト**: エンドツーエンドのユーザーシナリオテスト

### テストカバレッジ目標

- **単体テスト**: 80%以上
- **統合テスト**: 主要フロー
- **E2Eテスト**: ユーザーシナリオ

### テスト実行

#### バックエンド

```bash
cd api
pytest
pytest --cov=app tests/
```

#### フロントエンド

```bash
cd frontend
npm test
npm run test:coverage
```

### テストファイル命名

- **Python**: `test_*.py`（例: `test_user_service.py`）
- **TypeScript**: `*.test.tsx` または `*.spec.tsx`（例: `UserForm.test.tsx`）

---

## ドキュメント作成

### コードコメント

- **ファイル先頭**: ファイルの目的や役割を日本語で記述
- **クラス**: 扱う概念や継承元を日本語で記述
- **メソッド**: 機能、引数、戻り値の説明を日本語で記述

### APIドキュメント

- **OpenAPI**: FastAPIの自動生成ドキュメントを使用
- **エンドポイント説明**: 各エンドポイントの目的を記述

### 技術ドキュメント

- **Markdown形式**: すべてのドキュメントはMarkdown形式
- **日本語記述**: すべてのドキュメントは日本語で記述
- **図表**: Mermaid記法を使用

---

## 禁止事項

以下の行為は禁止されています：

- ハードコーディングされた認証情報
- 直接的なSQLクエリ（ORM使用）
- 同期処理での長時間処理
- 例外の握りつぶし
- デバッグ用のprint文
- コミットされていない環境変数ファイル（`.env.local`等）

---

## 推奨事項

以下の実践を推奨します：

- 型安全性の重視
- エラーハンドリングの徹底
- ログ出力の充実
- テストの自動化
- コードレビューの実施
- リファクタリングの継続
- ドキュメントの更新

---

## 開発ツール

### コードフォーマッター

#### Python

```bash
# Black
black app/

# isort
isort app/
```

#### TypeScript

```bash
# Prettier
npm run format

# ESLint
npm run lint
```

### リンター

#### Python

```bash
flake8 app/
```

#### TypeScript

```bash
npm run lint
```

---

## トラブルシューティング

### よくある問題

#### 型エラー

- TypeScript: `tsconfig.json` の設定を確認
- Python: `mypy` で型チェックを実行

#### インポートエラー

- Python: `PYTHONPATH` を確認
- TypeScript: `tsconfig.json` の `paths` を確認

#### テストが失敗する

- データベースの状態を確認
- 環境変数の設定を確認
- テストデータのクリーンアップを確認

---

**最終更新日**: 2025-01-XX

