# RAG AI Platform - Cursor Rules

## プロジェクト概要
このプロジェクトはRAG（Retrieval-Augmented Generation）AIチャットボットプラットフォームです。
マイクロサービス志向のアーキテクチャで、テナント分離、スケーラビリティ、セキュリティを重視しています。

## グローバルコーディング規約

### 必須要件
1. ファイルの先頭にファイルの目的や役割などを日本語で記述する
2. classには扱う概念や継承元などを日本語で記述する
3. methodには機能、引数、戻り値の説明を日本語で記述する
4. コメントは日本語で記述
5. エラーハンドリングは必ず実装
6. 認証・認可は必ず実装
7. 入力値は必ずバリデーション
8. SQLインジェクション対策
9. XSS対策
10. CSRF対策

## アーキテクチャ原則
- マイクロサービス志向：疎結合な機能分割
- マルチテナント：データ・リソース分離
- スケーラビリティ：水平スケール可能
- セキュリティファースト：多層防御
- 可観測性：監視・ログ・トレース

## 技術スタック
### バックエンド
- Python 3.11+ / FastAPI
- PostgreSQL + pgvector
- Redis (ElastiCache)
- AWS (ECS Fargate, RDS, S3)

### フロントエンド
- Next.js 15+ / React 18+
- TypeScript 5.2+
- Tailwind CSS + shadcn/ui
- React Hook Form + Zod

## コーディング規約

### Python (FastAPI)
- PEP 8に準拠
- 型ヒントを必ず記述
- 関数は最大50行以内
- クラスは最大300行以内
- エラーハンドリングは必ず実装
- ログ出力は構造化ログを使用
- 非同期処理を積極的に使用

### TypeScript (Next.js)
- strict modeを使用
- 関数は最大30行以内
- コンポーネントは最大200行以内
- Propsの型定義は必ず記述
- エラーバウンダリを実装
- アクセシビリティを考慮

### データベース
- テーブル名は複数形
- カラム名はsnake_case
- 外部キー制約を必ず設定
- インデックスを適切に設定
- RLS（Row Level Security）を実装
- **SQLAlchemyモデルとAlembicマイグレーションの整合性**:
  - 外部キー制約は`ForeignKey`を明示的に定義（`__table_args__`または`Column`定義で）
  - インデックスは`__table_args__`で明示的に定義
  - `server_default`を適切に設定（特に`created_at`、`updated_at`など）
  - `NOT NULL`制約があるカラムには必ずデフォルト値を設定
  - モデル定義とマイグレーションの差分を`alembic check`で定期的に確認

## セキュリティ要件
- 認証：JWT + OAuth2
- 認可：RBAC（Role-Based Access Control）
- 入力検証：Pydantic + Zod
- SQLインジェクション対策
- XSS対策
- CSRF対策
- レート制限実装

## パフォーマンス要件
- API応答時間：95%が3秒以内
- データベースクエリ：N+1問題を回避
- キャッシュ戦略：Redis活用
- 画像最適化：WebP対応
- バンドルサイズ：初期読み込み1MB以内

## テスト要件
- 単体テスト：カバレッジ80%以上
- 統合テスト：主要フロー
- E2Eテスト：ユーザーシナリオ
- パフォーマンステスト：負荷テスト

## ログ・監視
- 構造化ログ（JSON形式）
- ログレベル：ERROR, WARN, INFO, DEBUG
- メトリクス：Prometheus形式
- アラート：閾値設定
- トレーシング：OpenTelemetry

## デプロイ・運用
- コンテナ化：Docker
- CI/CD：GitHub Actions
- 環境分離：dev, staging, prod
- ブルーグリーンデプロイ
- ロールバック戦略

### CI/CD (GitHub Actions) ベストプラクティス
- **Vercelデプロイ**:
  - プロジェクトルートから`vercel`コマンドを実行（`cd frontend`は不要）
  - Vercelプロジェクトの`Root Directory`設定と`--cwd`オプションの重複に注意
  - `vercel.json`は`frontend`ディレクトリに配置するか、プロジェクトルートの設定と整合性を保つ
  - `--yes`オプションで対話的プロンプトをスキップ
- **Railwayデプロイ**:
  - `railway login --token`は無効なコマンド（使用禁止）
  - 環境変数`RAILWAY_TOKEN`を設定して認証（`railway login`コマンドは不要）
  - `RAILWAY_PROJECT_ID`と`RAILWAY_TOKEN`は環境変数として設定
- **環境変数管理**:
  - 認証情報は必ずGitHub Secretsに保存
  - 環境ごとに別々のSecretsを設定（`DEMO_*`, `PROD_*`など）
  - 環境変数名は明確で一貫性のある命名規則を使用
- **ストレージパス**:
  - 書き込み権限のない環境（CI/CD）を考慮したフォールバック処理を実装
  - `/tmp`ディレクトリをフォールバック先として使用可能にする
  - パス設定は環境変数で管理し、デフォルト値を設定

## ドキュメント
- API仕様：OpenAPI 3.0
- アーキテクチャ：C4モデル
- 運用手順：Runbook
- コメント：日本語で記述

## 禁止事項
- ハードコーディングされた認証情報
- 直接的なSQLクエリ（ORM使用）
- 同期処理での長時間処理
- 例外の握りつぶし
- デバッグ用のprint文
- **CI/CD関連の禁止事項**:
  - `railway login --token`コマンドの使用（無効なコマンド）
  - Vercelデプロイ時の`cd frontend`と`--cwd`オプションの併用（パス重複の原因）
  - 環境変数のハードコーディング（GitHub Secretsを使用）
  - 書き込み権限を前提としたファイルパス設定（フォールバック処理なし）

## 推奨事項
- 型安全性の重視
- エラーハンドリングの徹底
- ログ出力の充実
- テストの自動化
- コードレビューの実施
- リファクタリングの継続

## 命名規則
- ファイル名：snake_case (Python), kebab-case (TypeScript)
- 変数名：snake_case (Python), camelCase (TypeScript)
- 定数名：UPPER_SNAKE_CASE
- クラス名：PascalCase
- 関数名：動詞 + 名詞

## コミット規約
- feat: 新機能
- fix: バグ修正
- docs: ドキュメント
- style: フォーマット
- refactor: リファクタリング
- test: テスト
- chore: その他

例: `feat(auth): JWT認証機能を実装`
