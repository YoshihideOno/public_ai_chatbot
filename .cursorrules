# RAG AI Platform - Cursor Rules

## このファイルの構成
- **共通ルール**（他プロジェクトにも流用可能）:
  - `## グローバルコーディング規約`
  - `## セキュリティ要件`
  - `## パフォーマンス要件`
  - `## テスト要件`
  - `## ログ・監視`
  - `## 命名規則`
  - `## コミット規約`
- **本プロジェクト固有のルール**（RAG AI Platform専用）:
  - `## [本プロジェクト固有] プロジェクト概要`
  - `## [本プロジェクト固有] アーキテクチャ原則`
  - `## [本プロジェクト固有] 技術スタック`
  - `## デプロイ・運用` 内の Vercel / Railway / Neon など具体サービスに依存した記述
  - データベース接続のNeon固有パラメータなど、環境依存の詳細

## [本プロジェクト固有] プロジェクト概要
このプロジェクトはRAG（Retrieval-Augmented Generation）AIチャットボットプラットフォームです。
マイクロサービス志向のアーキテクチャで、テナント分離、スケーラビリティ、セキュリティを重視しています。

## グローバルコーディング規約

### 必須要件
1. ファイルの先頭にファイルの目的や役割などを日本語で記述する
2. classには扱う概念や継承元などを日本語で記述する
3. methodには機能、引数、戻り値の説明を日本語で記述する
4. コメントは日本語で記述
5. エラーハンドリングは必ず実装
6. 認証・認可は必ず実装
7. 入力値は必ずバリデーション
8. SQLインジェクション対策
9. XSS対策
10. CSRF対策

## [本プロジェクト固有] アーキテクチャ原則
- マイクロサービス志向：疎結合な機能分割
- マルチテナント：データ・リソース分離
- スケーラビリティ：水平スケール可能
- セキュリティファースト：多層防御
- 可観測性：監視・ログ・トレース

## [本プロジェクト固有] 技術スタック
### バックエンド
- Python 3.11+ / FastAPI
- PostgreSQL + pgvector
- Redis (ElastiCache)
- AWS (ECS Fargate, RDS, S3)

### フロントエンド
- Next.js 15+ / React 18+
- TypeScript 5.2+
- Tailwind CSS + shadcn/ui
- React Hook Form + Zod

## コーディング規約

### Python (FastAPI)
- PEP 8に準拠
- 型ヒントを必ず記述
- 関数は最大50行以内
- クラスは最大300行以内
- エラーハンドリングは必ず実装
- ログ出力は構造化ログを使用
- 非同期処理を積極的に使用

### TypeScript (Next.js)
- strict modeを使用
- 関数は最大30行以内
- コンポーネントは最大200行以内
- Propsの型定義は必ず記述
- エラーバウンダリを実装
- アクセシビリティを考慮
- **`any`型の使用を禁止**（ESLintルール`@typescript-eslint/no-explicit-any`に準拠）
  - 型が不明な場合は`unknown`型を使用し、型ガードで安全に処理
  - 既存の型定義を確認し、適切な型を使用（例: `Tenant`型のプロパティにアクセスする場合は`Tenant`型として扱う）
  - 型アサーション（`as any`）は使用禁止。必要に応じて適切な型定義を追加

### データベース
- テーブル名は複数形
- カラム名はsnake_case
- 外部キー制約を必ず設定
- インデックスを適切に設定
- RLS（Row Level Security）を実装
- **SQLAlchemyモデルとAlembicマイグレーションの整合性**:
  - 外部キー制約は`ForeignKey`を明示的に定義（`__table_args__`または`Column`定義で）
  - インデックスは`__table_args__`で明示的に定義
  - `server_default`を適切に設定（特に`created_at`、`updated_at`など）
  - `NOT NULL`制約があるカラムには必ずデフォルト値を設定
  - モデル定義とマイグレーションの差分を`alembic check`で定期的に確認
- **Alembicマイグレーションの管理**:
  - 新しいマイグレーションを作成する際は、既存のheadリビジョンを確認（`alembic heads`）
  - 複数のheadが存在する場合は、mergeマイグレーションを作成して統合
  - `down_revision`は最新の統合済みheadを指定（古いリビジョンを直接参照しない）
  - マイグレーション履歴は常に1つのheadに統合されている状態を維持
- **データベース接続文字列の扱い**:
  - `asyncpg`（非同期）と`psycopg2`（同期）でSSLパラメータの形式が異なる
  - `asyncpg`: `ssl=true`を使用（`sslmode`パラメータは理解しない）
  - `psycopg2`: `sslmode=require`を使用（`ssl=true`は理解しない）
  - `create_async_engine`では、URLクエリパラメータの`ssl=true`を`connect_args`の`ssl=True`に明示的に設定することを推奨
  - URLから`sslmode`、`channel_binding`パラメータを削除し、`connect_args`でSSL設定を管理
  - 環境変数は`ASYNC_DATABASE_URL`（FastAPI用）と`DATABASE_URL_SYNC`（Alembic用）を分離

## セキュリティ要件
- 認証：JWT + OAuth2
- 認可：RBAC（Role-Based Access Control）
- 入力検証：Pydantic + Zod
- SQLインジェクション対策
- XSS対策
- CSRF対策
- レート制限実装

## パフォーマンス要件
- API応答時間：95%が3秒以内
- データベースクエリ：N+1問題を回避
- キャッシュ戦略：Redis活用
- 画像最適化：WebP対応
- バンドルサイズ：初期読み込み1MB以内

## テスト要件
- 単体テスト：カバレッジ80%以上
- 統合テスト：主要フロー
- E2Eテスト：ユーザーシナリオ
- パフォーマンステスト：負荷テスト

## ログ・監視
- 構造化ログ（JSON形式）
- ログレベル：ERROR, WARN, INFO, DEBUG
- メトリクス：Prometheus形式
- アラート：閾値設定
- トレーシング：OpenTelemetry
- **デバッグ出力の扱い**:
  - 本番環境では`print`文を使用したデバッグ出力を避ける
  - デバッグ情報は`logging.debug()`または`logging.info()`を使用
  - 一時的なデバッグ出力は本番デプロイ前に削除するか、環境変数で制御
  - ログ初期化前に出力が必要な場合は`print`を使用し、`flush=True`を指定

## デプロイ・運用
- コンテナ化：Docker
- CI/CD：GitHub Actions
- 環境分離：dev, staging, prod
- ブルーグリーンデプロイ
- ロールバック戦略

### CI/CD (GitHub Actions) ベストプラクティス
- **変更前の必須チェック**:
  - 設定ファイル（JSON、YAML、INI等）を変更する場合は、必ず構文チェックを実施
  - JSONファイル: `python3 -m json.tool <file>` または `jq . <file>` で検証
  - YAMLファイル: `yamllint` または `python3 -c "import yaml; yaml.safe_load(open('<file>'))"` で検証
  - デプロイに8分以上かかるため、ケアレスミス（構文エラー、型エラー等）は事前に検出すべき
- **Vercelデプロイ**:
  - プロジェクトルートから`vercel`コマンドを実行（`cd frontend`は不要）
  - Vercelプロジェクトの`Root Directory`設定と`--cwd`オプションの重複に注意
  - `vercel.json`は`frontend`ディレクトリに配置するか、プロジェクトルートの設定と整合性を保つ
  - `--yes`オプションで対話的プロンプトをスキップ
- **Railwayデプロイ**:
  - `railway login --token`は無効なコマンド（使用禁止）
  - 環境変数`RAILWAY_TOKEN`を設定して認証（`railway login`コマンドは不要）
  - `RAILWAY_PROJECT_ID`と`RAILWAY_TOKEN`は環境変数として設定
  - **Dockerfile設定**:
    - `Dockerfile Path`: ビルドコンテキストが`api`ディレクトリの場合は`Dockerfile`（`api/Dockerfile`ではない）
    - `Build Context`: プロジェクトルートから見た`api`ディレクトリを指定
    - `Watch Paths`: `/ai_chatbot_app/**`のような古いパスではなく、`api/**`などの実際のパスを設定
    - `railway.json`で`dockerfilePath`と`watchPatterns`を明示的に定義することを推奨
    - **`railway.json`はJSON形式のため、コメント（`//`や`/* */`）を記述してはいけない**
- **環境変数管理**:
  - 認証情報は必ずGitHub Secretsに保存
  - 環境ごとに別々のSecretsを設定（`DEMO_*`, `PROD_*`など）
  - 環境変数名は明確で一貫性のある命名規則を使用
  - データベース接続は `ASYNC_DATABASE_URL`（FastAPI）と `DATABASE_URL_SYNC`（Alembic）を分離し、`postgresql+asyncpg://` と `postgresql://` を使い分ける
- **ストレージパス**:
  - 書き込み権限のない環境（CI/CD）を考慮したフォールバック処理を実装
  - `/tmp`ディレクトリをフォールバック先として使用可能にする
  - パス設定は環境変数で管理し、デフォルト値を設定

## ドキュメント
- API仕様：OpenAPI 3.0
- アーキテクチャ：C4モデル
- 運用手順：Runbook
- コメント：日本語で記述

## 禁止事項
- ハードコーディングされた認証情報
- 直接的なSQLクエリ（ORM使用）
- 同期処理での長時間処理
- 例外の握りつぶし
- デバッグ用のprint文（本番環境では削除またはログレベル調整）
- **TypeScript関連の禁止事項**:
  - `any`型の使用（`@typescript-eslint/no-explicit-any`ルール違反）
  - 型アサーション`as any`の使用
  - 未使用の変数・インポート（`@typescript-eslint/no-unused-vars`ルール違反）
- **データベース接続関連の禁止事項**:
  - `asyncpg`で`sslmode`パラメータを使用（`ssl=true`を使用）
  - `psycopg2`で`ssl=true`パラメータを使用（`sslmode=require`を使用）
  - URLクエリパラメータに`sslmode`と`ssl`を同時に含める
  - `create_async_engine`の`connect_args`でSSL設定を省略（URLパラメータのみに依存）
- **CI/CD関連の禁止事項**:
  - `railway login --token`コマンドの使用（無効なコマンド）
  - Vercelデプロイ時の`cd frontend`と`--cwd`オプションの併用（パス重複の原因）
  - 環境変数のハードコーディング（GitHub Secretsを使用）
  - 書き込み権限を前提としたファイルパス設定（フォールバック処理なし）
  - Railwayの`Dockerfile Path`と`Build Context`の不一致（`api/Dockerfile`と`api`ディレクトリの組み合わせなど）
  - **JSONファイルにコメントを記述**（JSONはコメントをサポートしていないため、パースエラーが発生する）
  - **設定ファイルやビルド関連の変更を事前チェックなしでコミット**（デプロイに時間がかかるため、構文エラーは事前に検出すべき）

## 推奨事項
- 型安全性の重視
- エラーハンドリングの徹底
- ログ出力の充実
- テストの自動化
- コードレビューの実施
- リファクタリングの継続
- **データベース接続の推奨事項**:
  - `create_async_engine`では`connect_args`に`ssl=True`を明示的に設定
  - URLからSSL関連パラメータ（`ssl`, `sslmode`, `channel_binding`）を削除し、`connect_args`で管理
  - 環境変数`ASYNC_DATABASE_URL`と`DATABASE_URL_SYNC`を分離して設定
  - URL正規化関数を実装し、`sslmode`を`ssl`に変換する処理を含める
- **デプロイ設定の推奨事項**:
  - Railwayの`railway.json`で`dockerfilePath`と`watchPatterns`を明示的に定義
  - Dockerfileの`COPY`コマンドはビルドコンテキストを考慮したパスを使用
  - デプロイ前にデバッグ出力を削除またはログレベルに変更
  - **設定ファイル変更時の推奨事項**:
    - JSONファイルにコメントが必要な場合は、別途`README.md`や`*.example`ファイルに記載
    - 設定ファイルを変更したら、必ず構文チェックを実施してからコミット
    - デプロイに時間がかかるため、構文エラーや型エラーは事前に検出すべき

## 命名規則
- ファイル名：snake_case (Python), kebab-case (TypeScript)
- 変数名：snake_case (Python), camelCase (TypeScript)
- 定数名：UPPER_SNAKE_CASE
- クラス名：PascalCase
- 関数名：動詞 + 名詞

## コミット規約
- feat: 新機能
- fix: バグ修正
- docs: ドキュメント
- style: フォーマット
- refactor: リファクタリング
- test: テスト
- chore: その他

例: `feat(auth): JWT認証機能を実装`
