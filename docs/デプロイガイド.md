# デプロイガイド

本ドキュメントでは、RAG AIプラットフォームの本番環境へのデプロイ手順を説明します。

## 目次

- [デプロイ環境](#デプロイ環境)
- [前提条件](#前提条件)
- [フロントエンドデプロイ（Vercel）](#フロントエンドデプロイvercel)
- [データベースセットアップ（Neon）](#データベースセットアップneon)
- [バックエンドデプロイ](#バックエンドデプロイ)
- [環境変数設定](#環境変数設定)
- [データベースマイグレーション](#データベースマイグレーション)
- [デプロイ後の確認](#デプロイ後の確認)
- [ロールバック手順](#ロールバック手順)

---

## デプロイ環境

### 環境構成

- **フロントエンド**: Vercel
- **バックエンド**: 別途ホスティング（要検討）
- **データベース**: Neon (PostgreSQL + pgvector)
- **ストレージ**: Vercel Blob Storage（本番環境）

### 環境分離

- **開発環境**: ローカル（Docker Compose）
- **ステージング環境**: Vercel Preview（フロントエンド）、別途ホスティング（バックエンド）
- **本番環境**: Vercel Production（フロントエンド）、別途ホスティング（バックエンド）

---

## 前提条件

- GitHubアカウント
- Vercelアカウント
- Neonアカウント
- ドメイン（オプション）

---

## フロントエンドデプロイ（Vercel）

### 1. Vercelプロジェクト作成

1. [Vercel Dashboard](https://vercel.com/dashboard) にログイン
2. 「Add New Project」をクリック
3. GitHubリポジトリを選択
4. プロジェクト設定:
   - **Framework Preset**: Next.js
   - **Root Directory**: `frontend`
   - **Build Command**: `npm run build`
   - **Output Directory**: `.next`
   - **Install Command**: `npm install`

### 2. 環境変数設定

Vercel Dashboard → Settings → Environment Variables で以下を設定:

#### 本番環境

```bash
NODE_ENV=production
NEXT_PUBLIC_APP_NAME=AI Chatbot
NEXT_PUBLIC_APP_VERSION=1.0.0
NEXT_PUBLIC_API_BASE_URL=https://api.example.com
NEXT_PUBLIC_WIDGET_CDN_URL=https://cdn.example.com/widget.js
NEXT_PUBLIC_API_URL=https://api.example.com/api/v1
```

#### ステージング環境

```bash
NODE_ENV=production
NEXT_PUBLIC_APP_NAME=AI Chatbot (Staging)
NEXT_PUBLIC_APP_VERSION=1.0.0
NEXT_PUBLIC_API_BASE_URL=https://staging-api.example.com
NEXT_PUBLIC_WIDGET_CDN_URL=https://staging-cdn.example.com/widget.js
NEXT_PUBLIC_API_URL=https://staging-api.example.com/api/v1
```

### 3. デプロイ

#### 自動デプロイ

- `main` ブランチへのマージで自動デプロイ（本番環境）
- Pull Requestで自動デプロイ（プレビュー環境）

#### 手動デプロイ

```bash
# Vercel CLIを使用
npm i -g vercel
cd frontend
vercel --prod
```

### 4. カスタムドメイン設定（オプション）

1. Vercel Dashboard → Settings → Domains
2. ドメインを追加
3. DNS設定を更新

---

## データベースセットアップ（Neon）

### 1. Neonプロジェクト作成

1. [Neon Console](https://console.neon.tech/) にログイン
2. 「Create Project」をクリック
3. プロジェクト設定:
   - **Project Name**: `rag-chatbot-prod`
   - **Region**: 最寄りのリージョンを選択
   - **PostgreSQL Version**: 17

### 2. 接続情報の取得

1. Neon Console → Project → Connection Details
2. 接続文字列をコピー:
   ```
   postgresql://user:password@ep-xxx-xxx.us-east-2.aws.neon.tech/neondb?sslmode=require
   ```

### 3. pgvector拡張の有効化

Neon Console → SQL Editor で以下を実行:

```sql
CREATE EXTENSION IF NOT EXISTS vector;
CREATE EXTENSION IF NOT EXISTS pgcrypto;
CREATE EXTENSION IF NOT EXISTS pg_trgm;
```

### 4. データベースマイグレーション

```bash
cd api
export DATABASE_URL="postgresql://user:password@ep-xxx-xxx.us-east-2.aws.neon.tech/neondb?sslmode=require"
alembic upgrade head
```

---

## バックエンドデプロイ

### オプション1: Dockerコンテナデプロイ

#### Dockerイメージのビルド

```bash
cd api
docker build -t rag-chatbot-api:latest .
```

#### コンテナの実行

```bash
docker run -d \
  --name rag-chatbot-api \
  -p 8000:8000 \
  -e DATABASE_URL="postgresql+asyncpg://..." \
  -e SECRET_KEY="..." \
  -e OPENAI_API_KEY="..." \
  rag-chatbot-api:latest
```

### オプション2: クラウドホスティング

#### AWS ECS Fargate（推奨）

1. ECRにイメージをプッシュ
2. ECSタスク定義を作成
3. ECSサービスを作成
4. ロードバランサーを設定

#### その他のオプション

- Google Cloud Run
- Azure Container Instances
- Railway（詳細は下記参照）
- Render

### オプション3: Railway（お披露目環境推奨）

#### Railwayの特徴
- ✅ 簡単なデプロイ（GitHubと連携）
- ✅ 自動スケーリング
- ✅ 無料枠あり（月500時間、5GBメモリ）
- ✅ CI/CDに最適

#### 1. Railwayプロジェクト作成

1. [Railway Dashboard](https://railway.app/) にログイン
2. 「New Project」をクリック
3. 「Deploy from GitHub repo」を選択
4. GitHubリポジトリを接続
5. サービス名を設定（例：`ai_chatbot_app`）

#### 2. 設定ファイルの配置

プロジェクトルートに`railway.json`を配置（既に設定済み）：

```json
{
  "$schema": "https://railway.app/railway.schema.json",
  "build": {
    "builder": "DOCKERFILE",
    "dockerfilePath": "api/Dockerfile",
    "watchPatterns": [
      "api/**/*.py",
      "api/**/*.txt",
      "api/Dockerfile",
      "api/alembic/**",
      "api/requirements.txt"
    ]
  },
  "deploy": {
    "startCommand": "sh -c \"cd /app && python -m alembic upgrade head && uvicorn main:app --host 0.0.0.0 --port ${PORT:-8000}\"",
    "restartPolicyType": "ON_FAILURE",
    "restartPolicyMaxRetries": 10
  }
}
```

#### 3. 環境変数の設定

Railway Dashboard → Variables で以下を設定：

```bash
# データベース（Neon）
DATABASE_URL=postgresql+asyncpg://user:password@ep-xxx-xxx.us-east-2.aws.neon.tech/neondb?ssl=true

# セキュリティ
SECRET_KEY=<強力なランダム文字列>
ACCESS_TOKEN_EXPIRE_MINUTES=30

# AI
OPENAI_API_KEY=sk-...

# ウィジェット・埋め込みコード設定（推奨）
WIDGET_CDN_URL=https://your-widget-cdn-url.com/widget.js
API_BASE_URL=https://your-api-url.com/api/v1

# その他必要な環境変数
```

#### 4. GitHub Actionsとの連携（オプション）

GitHub Secretsに以下を設定：

- `RAILWAY_TOKEN`: Account API Token（ワークスペース指定、推奨）または Project Token
- `RAILWAY_DEMO_PROJECT_ID`: プロジェクトID（URLから取得）
- `RAILWAY_DEMO_SERVICE`: サービス名

**Account API Tokenの生成時の注意**:
- トークン生成時に対象の**ワークスペースを選択**する必要があります
- 選択したワークスペース配下の全プロジェクトにアクセス可能になります

詳細は `docs/Railway_トークン管理.md` を参照。

---

## 環境変数設定

### バックエンド環境変数

本番環境で設定が必要な環境変数:

```bash
# データベース
DATABASE_URL=postgresql+asyncpg://user:password@ep-xxx-xxx.us-east-2.aws.neon.tech/neondb?sslmode=require

# セキュリティ（必須）
SECRET_KEY=<強力なランダム文字列（32文字以上）>
ACCESS_TOKEN_EXPIRE_MINUTES=30
REFRESH_TOKEN_EXPIRE_DAYS=7

# アプリケーション（必須）
ENVIRONMENT=production
DEBUG=false
LOG_LEVEL=warn
APP_URL=https://app.example.com

# AI API
OPENAI_API_KEY=sk-...
ANTHROPIC_API_KEY=...
GOOGLE_API_KEY=...

# 課金（必須）
STRIPE_SECRET_KEY=sk_live_...
STRIPE_PUBLISHABLE_KEY=pk_live_...
STRIPE_WEBHOOK_SECRET=whsec_...
STRIPE_PRICE_BASIC_MONTHLY=price_...
STRIPE_PRICE_BASIC_YEARLY=price_...
STRIPE_PRICE_PRO_MONTHLY=price_...
STRIPE_PRICE_PRO_YEARLY=price_...

# メール（必須）
RESEND_API_KEY=re_...
EMAIL_FROM_ADDRESS=noreply@example.com

# ストレージ
BLOB_READ_WRITE_TOKEN=vercel_blob_rw_...

# ウィジェット・埋め込みコード設定（推奨）
WIDGET_CDN_URL=https://your-widget-cdn-url.com/widget.js
API_BASE_URL=https://your-api-url.com/api/v1
```

### シークレットの生成

```bash
# SECRET_KEYの生成
python3 -c "import secrets; print(secrets.token_urlsafe(32))"

# または
openssl rand -hex 32
```

---

## データベースマイグレーション

### 初回マイグレーション

```bash
cd api
export DATABASE_URL="postgresql+asyncpg://..."
alembic upgrade head
```

### マイグレーション確認

```bash
alembic current
alembic history
```

### ロールバック（必要に応じて）

```bash
alembic downgrade -1
```

---

## デプロイ後の確認

### 1. ヘルスチェック

```bash
# バックエンド
curl https://api.example.com/health

# フロントエンド
curl https://app.example.com
```

### 2. API動作確認

```bash
# OpenAPIドキュメント
open https://api.example.com/docs

# ログイン
curl -X POST https://api.example.com/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email": "user@example.com", "password": "password"}'
```

### 3. ログ確認

- **Vercel**: Vercel Dashboard → Deployments → Logs
- **バックエンド**: ホスティング環境のログを確認

### 4. パフォーマンス確認

- レスポンス時間
- エラー率
- データベース接続数

---

## ロールバック手順

### フロントエンド（Vercel）

1. Vercel Dashboard → Deployments
2. ロールバックしたいデプロイを選択
3. 「Promote to Production」をクリック

### バックエンド

#### Dockerコンテナの場合

```bash
# 前のバージョンのイメージを使用
docker run -d \
  --name rag-chatbot-api \
  -p 8000:8000 \
  rag-chatbot-api:previous-version
```

#### データベースマイグレーションのロールバック

```bash
cd api
alembic downgrade -1
```

---

## CI/CD設定

### GitHub Actions

`.github/workflows/ci.yml` で自動テストとデプロイを設定:

```yaml
name: CI/CD

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Run tests
        run: |
          cd api
          pytest
      
  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v3
      - name: Deploy to production
        run: |
          # デプロイコマンド
```

### Vercel自動デプロイ

- `main` ブランチへのマージで自動デプロイ
- Pull Requestでプレビューデプロイ

---

## セキュリティチェックリスト

デプロイ前に以下を確認:

- [ ] 環境変数が適切に設定されているか
- [ ] `SECRET_KEY` が強力な値に設定されているか
- [ ] `DEBUG=false` が設定されているか
- [ ] CORS設定が適切か
- [ ] HTTPSが有効か
- [ ] データベース接続がSSL経由か
- [ ] APIキーが漏洩していないか

---

## トラブルシューティング

### デプロイが失敗する

1. ビルドログを確認
2. 環境変数の設定を確認
3. 依存関係のインストールを確認

### データベース接続エラー

1. 接続文字列を確認
2. SSL設定を確認
3. ファイアウォール設定を確認

### パフォーマンス問題

1. ログを確認
2. データベースクエリを最適化
3. キャッシュを確認

詳細は [トラブルシューティング.md](./トラブルシューティング.md) を参照してください。

---

**最終更新日**: 2025-01-XX

