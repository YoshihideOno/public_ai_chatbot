# テスト実行手順

## 1. Dockerコンテナ内でのテスト実行

### 1.1. バックエンドAPIテスト（pytest）

#### 前提条件
- Docker Composeが起動していること
- データベースがマイグレーション済みであること

#### 実行方法

```bash
# 全テストを実行
docker compose exec fastapi pytest -v

# 特定のテストファイルを実行
docker compose exec fastapi pytest tests/test_auth.py -v
docker compose exec fastapi pytest tests/test_users.py -v
docker compose exec fastapi pytest tests/test_chats.py -v
docker compose exec fastapi pytest tests/test_contents.py -v

# 境界値テストを実行
docker compose exec fastapi pytest tests/test_auth_boundary_values.py -v

# RLSと検索テストを実行
docker compose exec fastapi pytest tests/test_rls_and_search.py -v

# カバレッジ付きで実行
docker compose exec fastapi pytest -v --cov=app --cov-report=html tests/

# 詳細な出力で実行
docker compose exec fastapi pytest -v --tb=short tests/
```

#### テスト実行前の準備

```bash
# 1. Docker Composeでサービスを起動
docker compose up -d

# 2. データベースマイグレーション
docker compose exec fastapi alembic upgrade head

# 3. テスト実行
docker compose exec fastapi pytest -v
```

### 1.2. フロントエンドコンポーネントテスト（Jest）

#### 前提条件
- Docker Composeが起動していること
- フロントエンドコンテナが起動していること

#### 実行方法

```bash
# 全テストを実行
docker compose exec frontend-admin npm test

# 特定のテストファイルを実行
docker compose exec frontend-admin npm test -- LoginForm.test.tsx

# ウォッチモードで実行
docker compose exec frontend-admin npm test -- --watch

# カバレッジ付きで実行
docker compose exec frontend-admin npm test -- --coverage

# 詳細な出力で実行
docker compose exec frontend-admin npm test -- --verbose
```

#### テスト実行前の準備

```bash
# 1. Docker Composeでサービスを起動
docker compose up -d

# 2. フロントエンドの依存関係をインストール（初回のみ）
docker compose exec frontend-admin npm install

# 3. テスト実行
docker compose exec frontend-admin npm test
```

### 1.3. E2Eテスト（Playwright）

#### 実行方法

```bash
# 全E2Eテストを実行
docker compose exec frontend-admin npm run test:e2e

# 特定のテストファイルを実行
docker compose exec frontend-admin npm run test:e2e tests/auth.spec.ts

# UIモードで実行（デバッグ用）
docker compose exec frontend-admin npm run test:e2e -- --ui
```

#### 注意事項
- E2Eテスト実行時は、バックエンドAPIとデータベースが起動している必要があります
- テスト用のデータベースを使用することを推奨します

## 2. ローカル環境でのテスト実行（Docker Compose不使用）

### 2.1. バックエンドAPIテスト

#### 前提条件
- Python 3.11以上がインストールされていること
- PostgreSQL + pgvectorが起動していること
- 仮想環境が作成されていること

#### 実行方法

```bash
cd api

# 仮想環境をアクティベート
source venv/bin/activate  # Windows: venv\Scripts\activate

# 依存関係をインストール
pip install -r requirements.txt

# 環境変数を設定
export DATABASE_URL=postgresql+asyncpg://user:password@localhost:5432/ai_chatbot_db

# テスト実行
pytest -v

# カバレッジ付きで実行
pytest -v --cov=app --cov-report=html tests/
```

### 2.2. フロントエンドコンポーネントテスト

#### 前提条件
- Node.js 20以上がインストールされていること

#### 実行方法

```bash
cd frontend

# 依存関係をインストール
npm install

# テスト実行
npm test

# カバレッジ付きで実行
npm test -- --coverage
```

## 3. CI/CDでのテスト実行

GitHub Actionsで自動実行されます（`.github/workflows/ci.yml`参照）

## 4. テストデバッグ

### 4.1. ログの確認

```bash
# FastAPIコンテナのログを確認
docker compose logs -f fastapi

# フロントエンドコンテナのログを確認
docker compose logs -f frontend-admin

# データベースのログを確認
docker compose logs -f db
```

### 4.2. コンテナ内でシェルを開く

```bash
# FastAPIコンテナ内でシェルを開く
docker compose exec fastapi bash

# フロントエンドコンテナ内でシェルを開く
docker compose exec frontend-admin sh
```

### 4.3. データベースの確認

```bash
# PostgreSQLに接続
docker compose exec db psql -U user -d ai_chatbot_db

# テーブル一覧を確認
\dt

# ユーザーテーブルを確認
SELECT * FROM users LIMIT 10;
```

## 5. トラブルシューティング

### 5.1. テストが失敗する場合

1. **データベース接続エラー**
   - Docker Composeが起動しているか確認
   - データベースマイグレーションが実行されているか確認
   - 環境変数が正しく設定されているか確認

2. **インポートエラー**
   - 依存関係がインストールされているか確認
   - Pythonパスが正しく設定されているか確認

3. **タイムアウトエラー**
   - データベースの応答時間を確認
   - テストのタイムアウト設定を調整

### 5.2. テストが遅い場合

- 並列実行を有効にする: `pytest -n auto`
- 不要なテストをスキップする
- モックを使用して外部依存を減らす

## 6. テストカバレッジの確認

### バックエンド

```bash
docker compose exec fastapi pytest --cov=app --cov-report=html tests/
# カバレッジレポート: api/htmlcov/index.html
```

### フロントエンド

```bash
docker compose exec frontend-admin npm test -- --coverage
# カバレッジレポート: frontend/coverage/index.html
```

