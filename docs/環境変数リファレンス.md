# 環境変数リファレンス

本ドキュメントでは、RAG AIプラットフォームで使用するすべての環境変数について説明します。

## 目次

- [環境変数の読み込み順序](#環境変数の読み込み順序)
- [バックエンド（FastAPI）環境変数](#バックエンドfastapi環境変数)
- [フロントエンド（Next.js）環境変数](#フロントエンドnextjs環境変数)
- [Docker Compose環境変数](#docker-compose環境変数)
- [環境別設定例](#環境別設定例)
- [セキュリティベストプラクティス](#セキュリティベストプラクティス)

---

## 環境変数の読み込み順序

### バックエンド（FastAPI）

1. システム環境変数
2. `.env` ファイル（`api/.env`）
3. `.env.local` ファイル（ルートディレクトリ）

### フロントエンド（Next.js）

1. システム環境変数
2. `.env.local` ファイル（`frontend/.env.local`）
3. `.env` ファイル（`frontend/.env`）

**注意**: `NEXT_PUBLIC_` プレフィックスが付いた変数のみ、ブラウザ側でアクセス可能です。

---

## バックエンド（FastAPI）環境変数

### 必須環境変数

| 変数名 | 型 | 説明 | デフォルト値 | 例 |
|---|---|---|---|---|
| `ASYNC_DATABASE_URL` | string | FastAPI用（asyncpg）接続URL。未設定時は `DATABASE_URL` を流用 | `postgresql+asyncpg://user:password@db:5432/ai_chatbot_db` | `postgresql+asyncpg://user:pass@localhost:5432/db?ssl=true` |
| `DATABASE_URL_SYNC` | string | Alembic / 同期処理用接続URL。Neon提供の `postgresql://` 形式をそのまま設定 | `None` | `postgresql://user:pass@host/db?sslmode=require` |
| `DATABASE_URL` | string | 後方互換用。未設定時は `ASYNC_DATABASE_URL`/`DATABASE_URL_SYNC` が必須 | `postgresql+asyncpg://user:password@db:5432/ai_chatbot_db` | `postgresql+asyncpg://user:pass@localhost:5432/db` |
| `SECRET_KEY` | string | JWT署名用秘密鍵（本番環境では必須） | `your-secret-key-change-in-production` | ランダムな32文字以上の文字列 |

### データベース設定

| 変数名 | 型 | 説明 | デフォルト値 | 例 |
|---|---|---|---|---|
| `POSTGRES_USER` | string | PostgreSQLユーザー名 | `user` | `admin` |
| `POSTGRES_PASSWORD` | string | PostgreSQLパスワード | `password` | 強力なパスワード |
| `POSTGRES_DB` | string | PostgreSQLデータベース名 | `ai_chatbot_db` | `rag_chatbot` |

### セキュリティ設定

| 変数名 | 型 | 説明 | デフォルト値 | 例 |
|---|---|---|---|---|
| `ALGORITHM` | string | JWT署名アルゴリズム | `HS256` | `HS256` |
| `ACCESS_TOKEN_EXPIRE_MINUTES` | int | アクセストークン有効期限（分） | `30` | `60` |
| `REFRESH_TOKEN_EXPIRE_DAYS` | int | リフレッシュトークン有効期限（日） | `7` | `30` |
| `BACKEND_CORS_ORIGINS` | string[] | CORS許可オリジン（カンマ区切り） | `["http://localhost:3000", ...]` | `http://localhost:3000,https://app.example.com` |

### AI API設定（任意）

| 変数名 | 型 | 説明 | デフォルト値 | 例 |
|---|---|---|---|---|
| `OPENAI_API_KEY` | string | OpenAI APIキー | `None` | `sk-...` |
| `ANTHROPIC_API_KEY` | string | Anthropic APIキー | `None` | `sk-ant-...` |
| `GOOGLE_API_KEY` | string | Google Gemini APIキー | `None` | `AIza...` |

**注意**: これらのAPIキーは、テナント単位で管理画面から設定することも可能です。環境変数で設定した場合は、すべてのテナントでデフォルトとして使用されます。

### ベクトルDB設定（任意）

| 変数名 | 型 | 説明 | デフォルト値 | 例 |
|---|---|---|---|---|
| `VECTOR_DB_PROVIDER` | string | ベクトルDBプロバイダー（`stub` または `pinecone`） | `stub` | `pinecone` |
| `VECTORDB_PHYSICAL_ISOLATION` | string | 物理分離モード（`true` でテナント毎にindex） | `false` | `true` |
| `PINECONE_API_KEY` | string | Pinecone APIキー（Pinecone使用時） | `None` | `...` |
| `PINECONE_ENV` | string | Pinecone環境（Pinecone使用時） | `None` | `us-east-1` |
| `PINECONE_INDEX` | string | Pineconeインデックス名（Pinecone使用時） | `rag-chatbot` | `rag-chatbot-prod` |

### 課金・外部統合設定

| 変数名 | 型 | 説明 | デフォルト値 | 例 |
|---|---|---|---|---|
| `STRIPE_SECRET_KEY` | string | Stripe秘密鍵（本番環境では必須） | `None` | `sk_live_...` |
| `STRIPE_PUBLISHABLE_KEY` | string | Stripe公開鍵 | `None` | `pk_live_...` |
| `STRIPE_WEBHOOK_SECRET` | string | Stripe Webhook秘密鍵（本番環境では必須） | `None` | `whsec_...` |
| `STRIPE_PRICE_BASIC_MONTHLY` | string | Stripe Basic月額プラン価格ID | `None` | `price_...` |
| `STRIPE_PRICE_BASIC_YEARLY` | string | Stripe Basic年額プラン価格ID | `None` | `price_...` |
| `STRIPE_PRICE_PRO_MONTHLY` | string | Stripe Pro月額プラン価格ID | `None` | `price_...` |
| `STRIPE_PRICE_PRO_YEARLY` | string | Stripe Pro年額プラン価格ID | `None` | `price_...` |
| `RESEND_API_KEY` | string | Resend APIキー（メール送信用） | `None` | `re_...` |
| `EMAIL_FROM_ADDRESS` | string | 送信元メールアドレス | `noreply@synergysoft.jp` | `noreply@example.com` |
| `APP_URL` | string | アプリケーションURL（本番環境では必須） | `None` | `https://app.example.com` |

### ストレージ設定

| 変数名 | 型 | 説明 | デフォルト値 | 例 |
|---|---|---|---|---|
| `STORAGE_LOCAL_PATH` | string | ローカルストレージパス（未設定時は `/tmp/rag_storage` を使用） | `/tmp/rag_storage` | `/app/uploads` |
| `BLOB_READ_WRITE_TOKEN` | string | Vercel Blob Storageトークン（本番環境用） | `None` | `vercel_blob_rw_...` |

### アプリケーション設定

| 変数名 | 型 | 説明 | デフォルト値 | 例 |
|---|---|---|---|---|
| `PROJECT_NAME` | string | プロジェクト名 | `AI Chatbot API` | `My RAG Platform` |
| `VERSION` | string | アプリケーションバージョン | `1.0.0` | `1.2.3` |
| `API_V1_STR` | string | APIバージョン文字列 | `/api/v1` | `/api/v1` |
| `ENVIRONMENT` | string | 実行環境（`development`, `staging`, `production`） | `development` | `production` |
| `DEBUG` | bool | デバッグモード | `True` | `false` |
| `TIMEZONE` | string | アプリケーションタイムゾーン | `Asia/Tokyo` | `UTC` |
| `LOG_LEVEL` | string | ログレベル（`DEBUG`, `INFO`, `WARN`, `ERROR`） | `INFO` | `DEBUG` |

---

## フロントエンド（Next.js）環境変数

### 必須環境変数

| 変数名 | 型 | 説明 | デフォルト値 | 例 |
|---|---|---|---|---|
| `NEXT_PUBLIC_APP_NAME` | string | アプリケーション名（ブラウザ側でアクセス可能） | `AI Chatbot` | `My RAG Platform` |
| `NEXT_PUBLIC_API_BASE_URL` | string | APIベースURL（ブラウザ側でアクセス可能） | `http://localhost:8000` | `https://api.example.com` |
| `FASTAPI_BASE_URL` | string | FastAPIベースURL（サーバー側のみ） | `http://localhost:8000` | `https://api.example.com` |

### ウィジェット設定（任意）

| 変数名 | 型 | 説明 | デフォルト値 | 例 |
|---|---|---|---|---|
| `NEXT_PUBLIC_WIDGET_TENANT_ID` | string | ウィジェット用テナントID（ブラウザ側でアクセス可能） | `None` | `tenant-uuid` |
| `NEXT_PUBLIC_WIDGET_API_KEY` | string | ウィジェット用APIキー（ブラウザ側でアクセス可能） | `None` | `api-key-string` |
| `NEXT_PUBLIC_WIDGET_CDN_URL` | string | 本番用ウィジェットCDN URL（ブラウザ／サーバー双方で参照） | `https://cdn.rag-chatbot.com/widget.js` | `https://widget.example.com/widget.js` |
| `NEXT_PUBLIC_WIDGET_URL` | string | 開発時にローカルウィジェットを参照するためのURL（任意） | `http://localhost:3001/widget.js` | `http://localhost:3001/widget.js` |
| `NEXT_PUBLIC_API_URL` | string | API URL（ブラウザ側でアクセス可能） | `None` | `https://api.example.com` |

### アプリケーション設定

| 変数名 | 型 | 説明 | デフォルト値 | 例 |
|---|---|---|---|---|
| `NEXT_PUBLIC_APP_VERSION` | string | アプリケーションバージョン（ブラウザ側でアクセス可能） | `1.0.0` | `1.2.3` |
| `NODE_ENV` | string | Node.js環境（`development`, `production`） | `development` | `production` |

---

## Docker Compose環境変数

Docker Composeでは、ルートディレクトリの `.env.local` ファイルから環境変数を読み込みます。

### 共通設定

| 変数名 | 型 | 説明 | デフォルト値 | 例 |
|---|---|---|---|---|
| `NODE_ENV` | string | Node.js環境 | `development` | `production` |
| `TZ` | string | タイムゾーン | `Asia/Tokyo` | `UTC` |

### データベース設定

Docker Composeの `db` サービスで使用：

| 変数名 | 型 | 説明 | デフォルト値 | 例 |
|---|---|---|---|---|
| `POSTGRES_USER` | string | PostgreSQLユーザー名 | `user` | `admin` |
| `POSTGRES_PASSWORD` | string | PostgreSQLパスワード | `password` | 強力なパスワード |
| `POSTGRES_DB` | string | PostgreSQLデータベース名 | `ai_chatbot_db` | `rag_chatbot` |

---

## 環境別設定例

### 開発環境（ローカル）

**`.env.local`（ルート）:**

```bash
# データベース
ASYNC_DATABASE_URL=postgresql+asyncpg://user:password@db:5432/ai_chatbot_db
DATABASE_URL_SYNC=postgresql://user:password@db:5432/ai_chatbot_db
POSTGRES_USER=user
POSTGRES_PASSWORD=password
POSTGRES_DB=ai_chatbot_db

# セキュリティ
SECRET_KEY=dev-secret-key-change-in-production
ACCESS_TOKEN_EXPIRE_MINUTES=30

# アプリケーション
NODE_ENV=development
DEBUG=true
LOG_LEVEL=debug

# AI API（任意）
# OPENAI_API_KEY=sk-...
# ANTHROPIC_API_KEY=...

# ストレージ
# Docker コンテナとホストで共有したい場合のみ上書き
STORAGE_LOCAL_PATH=/tmp/rag_storage
```

**`frontend/.env.local`:**

```bash
NEXT_PUBLIC_APP_NAME=AI Chatbot (Dev)
NEXT_PUBLIC_API_BASE_URL=http://localhost:8000
FASTAPI_BASE_URL=http://localhost:8000
```

### ステージング環境

**`.env.staging`:**

```bash
# データベース
ASYNC_DATABASE_URL=postgresql+asyncpg://user:password@staging-db:5432/ai_chatbot_db
DATABASE_URL_SYNC=postgresql://user:password@staging-db:5432/ai_chatbot_db

# セキュリティ
SECRET_KEY=<強力なランダム文字列>
ACCESS_TOKEN_EXPIRE_MINUTES=60

# アプリケーション
ENVIRONMENT=staging
DEBUG=false
LOG_LEVEL=info

# AI API
OPENAI_API_KEY=sk-...
ANTHROPIC_API_KEY=...

# ストレージ
BLOB_READ_WRITE_TOKEN=vercel_blob_rw_...
```

### 本番環境

**`.env.production`:**

```bash
# データベース
ASYNC_DATABASE_URL=postgresql+asyncpg://user:password@prod-db:5432/ai_chatbot_db
DATABASE_URL_SYNC=postgresql://user:password@prod-db:5432/ai_chatbot_db

# セキュリティ（必須）
SECRET_KEY=<強力なランダム文字列（32文字以上）>
ACCESS_TOKEN_EXPIRE_MINUTES=30
REFRESH_TOKEN_EXPIRE_DAYS=7

# アプリケーション（必須）
ENVIRONMENT=production
DEBUG=false
LOG_LEVEL=warn
APP_URL=https://app.example.com

# AI API
OPENAI_API_KEY=sk-...
ANTHROPIC_API_KEY=...
GOOGLE_API_KEY=...

# 課金（必須）
STRIPE_SECRET_KEY=sk_live_...
STRIPE_PUBLISHABLE_KEY=pk_live_...
STRIPE_WEBHOOK_SECRET=whsec_...
STRIPE_PRICE_BASIC_MONTHLY=price_...
STRIPE_PRICE_BASIC_YEARLY=price_...
STRIPE_PRICE_PRO_MONTHLY=price_...
STRIPE_PRICE_PRO_YEARLY=price_...

# メール（必須）
RESEND_API_KEY=re_...
EMAIL_FROM_ADDRESS=noreply@example.com

# ストレージ
BLOB_READ_WRITE_TOKEN=vercel_blob_rw_...
```

---

## セキュリティベストプラクティス

### 1. 秘密鍵の管理

- **SECRET_KEY**: 本番環境では必ず強力なランダム文字列（32文字以上）を使用
- **APIキー**: 環境変数ファイルに直接記述せず、シークレット管理サービスを使用
- **データベースパスワード**: 強力なパスワードを使用し、定期的にローテーション

### 2. 環境変数ファイルの保護

```bash
# .env.local を .gitignore に追加
echo ".env.local" >> .gitignore

# ファイルの権限を制限（Linux/Mac）
chmod 600 .env.local
```

### 3. 本番環境での設定

- 環境変数は環境変数管理サービス（Vercel、AWS Secrets Manager等）で管理
- `.env` ファイルをリポジトリにコミットしない
- 本番環境では `DEBUG=false` を必ず設定
- CORS設定を適切に制限

### 4. シークレットの生成

```bash
# SECRET_KEYの生成（Python）
python3 -c "import secrets; print(secrets.token_urlsafe(32))"

# SECRET_KEYの生成（OpenSSL）
openssl rand -hex 32
```

### 5. 環境変数の検証

アプリケーション起動時に、必須環境変数が設定されているか確認されます。設定が不足している場合は、エラーメッセージが表示されます。

---

## 運用環境の手動設定手順

### Railway（Neon接続）
1. Railwayダッシュボードで対象サービスを開き、`Variables` を選択。
2. Neonの接続文字列をそのまま `DATABASE_URL_SYNC` に設定（例: `postgresql://...neon.tech/neondb?sslmode=require`）。
3. 同じ文字列のスキームを `postgresql+asyncpg://` に変更し、末尾パラメータを `?ssl=true` に揃えたものを `ASYNC_DATABASE_URL` に設定。
4. 既存の `DATABASE_URL` は `ASYNC_DATABASE_URL` と同じ値に更新するか、未設定でも可（後方互換が不要な場合は削除可）。
5. 変更後に Railway の再デプロイを実行し、ログで `alembic upgrade head` が成功することを確認。

### GitHub Actions Secrets
1. リポジトリ設定の **Settings > Secrets and variables > Actions** を開く。
2. フロント/バックエンド各環境向けに `*_DATABASE_URL_SYNC` と `*_ASYNC_DATABASE_URL` を追加（例: `DEMO_DATABASE_URL_SYNC`）。
3. Workflow 内で FastAPI 用には async URL、Alembic 用には sync URL を渡すよう `env` ブロックを更新。

### ローカル `.env`
1. `env.example` を `.env.local` にコピー後、接続先に応じて `ASYNC_DATABASE_URL` / `DATABASE_URL_SYNC` を設定。
2. `alembic upgrade head` を直接実行する場合は `.env.local` から `DATABASE_URL_SYNC` が読み込まれるため、`postgresql://` 形式になっているか確認。
3. pytest では `api/tests/conftest.py` で `/tmp` 配下のパスが自動設定されるため、追加作業は不要。

---

## トラブルシューティング

### 環境変数が読み込まれない

1. ファイル名を確認（`.env.local`、`.env`）
2. ファイルの場所を確認（ルートディレクトリ、`api/`、`frontend/`）
3. 環境変数名のタイポを確認
4. Docker Composeを使用している場合、`env_file` の設定を確認

### フロントエンドで環境変数にアクセスできない

- `NEXT_PUBLIC_` プレフィックスが付いているか確認
- ビルド後に変更した場合は、再ビルドが必要

### 本番環境での設定エラー

- 必須環境変数が設定されているか確認
- 環境変数の値が正しい形式か確認
- ログを確認してエラーメッセージを確認

---

**最終更新日**: 2025-01-XX

