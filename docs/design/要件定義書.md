# 要件定義書

## 1. プロジェクト概要

### 1.1 プロジェクト名
RAG AIチャットボットプラットフォーム

### 1.2 プロジェクト目的
RAG（Retrieval-Augmented Generation）技術を活用した、マルチテナント対応のAIチャットボットプラットフォームを提供する。

### 1.3 対象ユーザー
- **エンドユーザー**: 企業の顧客・従業員（チャットボットを利用する側）
- **管理者**: 企業の管理者（ナレッジベースを管理する側）
- **プラットフォーム管理者**: システム全体を管理する側

---

## 2. 機能要件

### 2.1 認証・認可機能

#### 2.1.1 ユーザー登録
- **要件**: 新規ユーザーがメールアドレス、ユーザー名、パスワードで登録できる
- **詳細**:
  - メールアドレスの重複チェック
  - パスワード強度チェック（8文字以上、大文字・小文字・数字を含む）
  - テナント作成と同時にユーザー登録も可能

#### 2.1.2 ログイン・ログアウト
- **要件**: 登録済みユーザーがログイン・ログアウトできる
- **詳細**:
  - JWT認証を使用
  - アクセストークン（30分有効）とリフレッシュトークン（7日有効）を発行
  - ログアウト時にトークンを無効化

#### 2.1.3 パスワードリセット
- **要件**: パスワードを忘れたユーザーがリセットできる
- **詳細**:
  - メールアドレスを入力してリセットリンクを送信
  - リンクから新しいパスワードを設定

#### 2.1.4 ロールベースアクセス制御（RBAC）
- **要件**: ユーザーロールに応じた権限管理
- **ロール定義**:
  - **PLATFORM_ADMIN**: プラットフォーム全体の管理
  - **ADMIN**: テナント内の全権限
  - **OPERATOR**: コンテンツ管理、チャット実行
  - **USER**: チャット実行のみ
  - **AUDITOR**: 閲覧のみ

### 2.2 マルチテナント機能

#### 2.2.1 テナント管理
- **要件**: 複数の企業（テナント）を分離して管理
- **詳細**:
  - テナント作成・更新・削除
  - テナント毎にデータを完全分離
  - テナント設定の管理（埋め込みモデル、LLMモデル等）

#### 2.2.2 テナント分離
- **要件**: テナント間でデータが混在しない
- **詳細**:
  - すべてのデータに `tenant_id` を付与
  - クエリ時に必ず `tenant_id` でフィルタリング
  - Row Level Security（RLS）による自動分離（将来実装）

### 2.3 コンテンツ管理機能

#### 2.3.1 ファイルアップロード
- **要件**: ナレッジベースとなるファイルをアップロードできる
- **詳細**:
  - 対応形式: PDF, TXT, DOCX
  - 最大ファイルサイズ: 100MB
  - ファイル情報（タイトル、説明、タグ）の設定

#### 2.3.2 ファイル処理
- **要件**: アップロードされたファイルを自動処理
- **詳細**:
  - テキスト抽出
  - チャンキング（デフォルト: 1024文字、オーバーラップ200文字）
  - ベクトル化（OpenAI埋め込みモデル）
  - データベースへの保存

#### 2.3.3 ファイル管理
- **要件**: アップロードされたファイルを管理できる
- **詳細**:
  - ファイル一覧表示（検索・フィルタ機能）
  - ファイル削除
  - ファイルステータス確認（pending, processing, completed, failed）

### 2.4 RAGチャット機能

#### 2.4.1 チャット応答生成
- **要件**: ユーザーの質問に対して、ナレッジベースに基づいた回答を生成
- **詳細**:
  - ユーザークエリから埋め込みベクトルを生成
  - ベクトル検索で関連チャンクを取得（デフォルト: top 5）
  - 会話履歴を考慮した検索クエリ生成
  - 検索結果の再ランキング
  - LLMで応答生成（OpenAI, Anthropic, Google Gemini対応）

#### 2.4.2 会話履歴管理
- **要件**: 会話履歴を保持してコンテキストを維持
- **詳細**:
  - セッションIDによる会話のグループ化
  - 最新10件の会話履歴を取得
  - 会話履歴の保存

#### 2.4.3 ソース表示
- **要件**: 回答の根拠となった文書を表示
- **詳細**:
  - 使用されたチャンクのファイル名、チャンクインデックスを表示
  - チャンクテキストの一部を表示

### 2.5 ウィジェット機能

#### 2.5.1 チャットウィジェット
- **要件**: 外部サイトに埋め込めるチャットウィジェットを提供
- **詳細**:
  - Shadow DOMによるスタイル分離
  - SPA/MPA自動検出
  - カスタマイズ可能なUI
  - テナントAPIキーによる認証

#### 2.5.2 埋め込みコード生成
- **要件**: テナント専用の埋め込みコードを生成
- **詳細**:
  - テナントIDとAPIキーを含む埋め込みコード
  - CDN URLの提供

### 2.6 APIキー管理機能

#### 2.6.1 AI APIキー管理
- **要件**: テナント単位でAIプロバイダーのAPIキーを管理
- **詳細**:
  - 複数プロバイダー対応（OpenAI, Anthropic, Google）
  - 暗号化して保存
  - APIキーの登録・更新・削除

### 2.7 統計・分析機能

#### 2.7.1 使用量統計
- **要件**: テナントの使用量を可視化
- **詳細**:
  - トークン使用量
  - コスト計算
  - 期間別集計（日次、週次、月次）

#### 2.7.2 クエリ分析
- **要件**: よくある質問を分析
- **詳細**:
  - クエリのクラスタリング
  - 頻度ランキング
  - 評価・応答時間の集計

#### 2.7.3 監査ログ
- **要件**: 重要な操作を記録
- **詳細**:
  - ユーザー操作の記録
  - アクセスログ
  - セキュリティイベントの記録

### 2.8 課金機能

#### 2.8.1 サブスクリプション管理
- **要件**: Stripe統合による課金
- **詳細**:
  - プラン選択（BASIC, PRO）
  - 月額・年額プラン
  - Checkout Session作成
  - Webhook処理

---

## 3. 非機能要件

### 3.1 パフォーマンス要件

- **API応答時間**: 95%が3秒以内
- **チャット応答時間**: 平均2秒以内
- **ファイル処理時間**: 1MBあたり10秒以内
- **同時接続数**: 1000接続以上

### 3.2 可用性要件

- **稼働率**: 99.9%以上
- **ダウンタイム**: 月間43分以内
- **バックアップ**: 日次自動バックアップ
- **復旧時間**: 4時間以内

### 3.3 セキュリティ要件

- **認証**: JWT + OAuth2
- **認可**: RBAC
- **データ暗号化**: 転送時（TLS 1.3）、保存時（APIキー等）
- **入力検証**: Pydantic + Zod
- **SQLインジェクション対策**: ORM使用
- **XSS対策**: 入力サニタイゼーション
- **CSRF対策**: フレームワーク標準機能

### 3.4 スケーラビリティ要件

- **水平スケーリング**: 対応
- **データベース**: 読み取りレプリカ対応（将来実装）
- **キャッシュ**: Redis対応（将来実装）

### 3.5 保守性要件

- **コードカバレッジ**: 80%以上
- **ドキュメント**: 日本語で記述
- **ログ**: 構造化ログ（JSON形式）
- **監視**: Prometheus形式メトリクス（将来実装）

### 3.6 互換性要件

- **ブラウザ**: Chrome, Firefox, Safari, Edge（最新2バージョン）
- **モバイル**: レスポンシブデザイン対応
- **API**: RESTful API（OpenAPI 3.0準拠）

---

## 4. 制約事項

### 4.1 技術的制約

- PostgreSQL 17+ with pgvector必須
- Python 3.11+必須
- Node.js 20+必須

### 4.2 ビジネス制約

- テナント毎にデータ分離が必須
- コンプライアンス要件（GDPR等）への対応

### 4.3 運用制約

- 本番環境でのデバッグモードは無効化
- 環境変数による設定管理

---

## 5. 将来拡張予定

- マルチモーダル対応（画像、音声）
- ハイブリッド検索（ベクトル検索 + 全文検索）
- ストリーミング応答
- 多言語対応
- カスタムプロンプト設定
- ワークフロー機能

---

**作成日**: 2025-01-XX  
**最終更新日**: 2025-01-XX

