# トラブルシューティング

本ドキュメントでは、RAG AIプラットフォームでよく発生する問題とその解決方法を説明します。

## 目次

- [よくある問題](#よくある問題)
- [エラーログの読み方](#エラーログの読み方)
- [パフォーマンス問題の診断](#パフォーマンス問題の診断)
- [デバッグ方法](#デバッグ方法)
- [サポート](#サポート)

---

## よくある問題

### データベース接続エラー

#### 症状

```
sqlalchemy.exc.OperationalError: could not connect to server
```

#### 原因

- データベースサーバーが起動していない
- 接続情報が間違っている
- ファイアウォールでブロックされている

#### 解決方法

1. **データベースサーバーの状態を確認**

```bash
# Docker Composeの場合
docker compose ps db

# ログを確認
docker compose logs db
```

2. **接続情報を確認**

```bash
# 環境変数を確認
echo $DATABASE_URL

# 接続テスト
psql $DATABASE_URL
```

3. **ファイアウォール設定を確認**

- ポート5432が開いているか確認
- セキュリティグループの設定を確認（クラウド環境の場合）

---

### 認証エラー

#### 症状

```
401 Unauthorized
```

#### 原因

- トークンが無効または期限切れ
- トークンが正しく送信されていない

#### 解決方法

1. **トークンの有効期限を確認**

```bash
# トークンをデコード（JWT）
# https://jwt.io/ で確認可能
```

2. **リフレッシュトークンを使用**

```bash
curl -X POST http://localhost:8000/api/v1/auth/refresh \
  -H "Content-Type: application/json" \
  -d '{"refresh_token": "..."}'
```

3. **再ログイン**

```bash
curl -X POST http://localhost:8000/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email": "user@example.com", "password": "password"}'
```

---

### ファイルアップロードエラー

#### 症状

```
ファイル処理が失敗する
ステータスが FAILED になる
```

#### 原因

- ファイルサイズが大きすぎる
- サポートされていないファイル形式
- ストレージへのアクセスエラー

#### 解決方法

1. **ファイルサイズを確認**

- 最大ファイルサイズ: 100MB（デフォルト）
- 環境変数で変更可能

2. **ファイル形式を確認**

- サポート形式: PDF, TXT, DOCX
- その他の形式は将来対応予定

3. **ストレージ設定を確認**

```bash
# ローカルストレージの場合
ls -la /app/uploads

# Vercel Blob Storageの場合
# BLOB_READ_WRITE_TOKEN が設定されているか確認
```

---

### ベクトル検索が遅い

#### 症状

```
チャット応答が遅い
ベクトル検索に時間がかかる
```

#### 原因

- インデックスが作成されていない
- チャンク数が多すぎる
- データベースのリソース不足

#### 解決方法

1. **インデックスの確認**

```sql
-- HNSWインデックスの確認
SELECT indexname, indexdef
FROM pg_indexes
WHERE tablename = 'chunks' AND indexname LIKE '%embedding%';
```

2. **インデックスの作成**

```sql
-- HNSWインデックスの作成
CREATE INDEX ON chunks USING hnsw (embedding vector_l2_ops);
```

3. **データベースリソースの確認**

- CPU使用率
- メモリ使用率
- ディスクI/O

---

### LLM APIエラー

#### 症状

```
OpenAI API error: Rate limit exceeded
Anthropic API error: Invalid API key
```

#### 原因

- APIキーが無効
- レート制限超過
- ネットワークエラー

#### 解決方法

1. **APIキーの確認**

```bash
# 環境変数を確認
echo $OPENAI_API_KEY

# テナント設定からAPIキーを確認
# 管理画面で確認可能
```

2. **レート制限の確認**

- OpenAI: [Usage Dashboard](https://platform.openai.com/usage)
- Anthropic: [Dashboard](https://console.anthropic.com/)

3. **リトライ設定の確認**

- デフォルトで最大3回リトライ
- リトライ間隔: 1秒

---

## エラーログの読み方

### ログレベル

- **ERROR**: エラー（処理が失敗）
- **WARN**: 警告（処理は成功したが注意が必要）
- **INFO**: 情報（通常の処理）
- **DEBUG**: デバッグ（詳細情報）

### ログ形式

```json
{
  "timestamp": "2025-01-01T00:00:00Z",
  "level": "ERROR",
  "message": "エラーメッセージ",
  "module": "app.services.rag_pipeline",
  "function": "generate_response",
  "tenant_id": "uuid",
  "user_id": "uuid",
  "error": {
    "type": "ValueError",
    "message": "詳細なエラーメッセージ",
    "traceback": "..."
  }
}
```

### ログの確認方法

#### ローカル環境

```bash
# Docker Composeの場合
docker compose logs -f fastapi

# 個別起動の場合
# 標準出力に表示
```

#### 本番環境

- **Vercel**: Vercel Dashboard → Deployments → Logs
- **バックエンド**: ホスティング環境のログを確認

---

## パフォーマンス問題の診断

### レスポンス時間が遅い

#### 診断手順

1. **APIレスポンス時間の測定**

```bash
# curlで測定
time curl -X POST http://localhost:8000/api/v1/chats/rag \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"query": "test"}'
```

2. **データベースクエリの確認**

```sql
-- スロークエリの確認
SELECT query, mean_exec_time, calls
FROM pg_stat_statements
ORDER BY mean_exec_time DESC
LIMIT 10;
```

3. **ログの確認**

- パフォーマンスログを確認
- ボトルネックを特定

#### 解決方法

- **インデックスの追加**: よく使用されるカラムにインデックスを作成
- **クエリの最適化**: N+1問題の回避、JOINの最適化
- **キャッシュの活用**: Redisを使用（将来実装予定）

---

### メモリ使用量が高い

#### 診断手順

```bash
# プロセスのメモリ使用量を確認
ps aux | grep uvicorn

# Dockerコンテナの場合
docker stats
```

#### 解決方法

- **チャンクサイズの調整**: チャンクサイズを小さくする
- **バッチサイズの調整**: 一度に処理するチャンク数を減らす
- **リソースの増強**: メモリを増やす

---

### データベース接続数が多い

#### 診断手順

```sql
-- アクティブな接続数を確認
SELECT count(*) FROM pg_stat_activity;

-- 接続の詳細を確認
SELECT pid, usename, application_name, state, query
FROM pg_stat_activity
WHERE datname = 'ai_chatbot_db';
```

#### 解決方法

- **接続プールの設定**: 最大接続数を制限
- **アイドル接続のタイムアウト**: 長時間アイドルな接続を切断
- **接続の再利用**: 同じ接続を再利用

---

## デバッグ方法

### ローカル環境でのデバッグ

#### Pythonデバッガー（pdb）

```python
# コードにブレークポイントを設定
import pdb; pdb.set_trace()

# または
breakpoint()
```

#### ログレベルの変更

```bash
# 環境変数で変更
export LOG_LEVEL=DEBUG

# または .env ファイルで設定
LOG_LEVEL=debug
```

#### データベースクエリの確認

```python
# SQLAlchemyのechoを有効化
engine = create_async_engine(
    DATABASE_URL,
    echo=True  # SQLクエリをログに出力
)
```

### 本番環境でのデバッグ

#### ログの確認

- エラーログを確認
- パフォーマンスログを確認
- ビジネスログを確認

#### メトリクスの確認

- レスポンス時間
- エラー率
- リクエスト数

#### トレーシング（将来実装予定）

- OpenTelemetryを使用
- 分散トレーシングでリクエストフローを追跡

---

## サポート

### ドキュメント

- [開発環境セットアップ.md](./開発環境セットアップ.md)
- [環境変数リファレンス.md](./環境変数リファレンス.md)
- [APIリファレンス.md](./APIリファレンス.md)

### コミュニティ

- GitHub Issues: バグ報告・機能要望
- ドキュメント: 技術ドキュメント

### エスカレーション

問題が解決しない場合:

1. エラーログを収集
2. 再現手順を記録
3. GitHub Issueを作成

---

**最終更新日**: 2025-01-XX

