# セキュリティ設計書

## 1. 概要

### 1.1 セキュリティ方針
- **セキュリティファースト**: セキュリティを最優先に設計
- **多層防御**: 複数の防御層を実装
- **最小権限の原則**: 必要最小限の権限のみ付与
- **防御の深度**: 単一の防御に依存しない

### 1.2 セキュリティ要件
- 認証・認可の実装
- データ保護
- 通信の暗号化
- 入力検証
- ログ・監視

---

## 2. 認証・認可設計

### 2.1 認証方式

#### 2.1.1 JWT認証
- **アルゴリズム**: HS256
- **トークン形式**: JWT
- **有効期限**:
  - アクセストークン: 30分
  - リフレッシュトークン: 7日
- **ペイロード**:
  ```json
  {
    "sub": "user_id",
    "email": "user@example.com",
    "role": "OPERATOR",
    "tenant_id": "tenant_id",
    "exp": 1234567890,
    "iat": 1234567890
  }
  ```

#### 2.1.2 パスワード管理
- **ハッシュ化**: bcrypt（コストファクター: 12）
- **パスワード要件**:
  - 8文字以上
  - 大文字・小文字・数字を含む
- **パスワードリセット**: トークンベース（有効期限: 1時間）

### 2.2 認可設計

#### 2.2.1 RBAC（ロールベースアクセス制御）

**ロール定義**:

| ロール | 権限 |
|---|---|
| PLATFORM_ADMIN | プラットフォーム全体の管理 |
| ADMIN | テナント内の全権限 |
| OPERATOR | コンテンツ管理、チャット実行 |
| USER | チャット実行のみ |
| AUDITOR | 閲覧のみ |

**権限マトリクス**:

| 機能 | PLATFORM_ADMIN | ADMIN | OPERATOR | USER | AUDITOR |
|---|---|---|---|---|---|
| ユーザー管理 | ○ | ○ | × | × | × |
| テナント管理 | ○ | ○ | × | × | × |
| ファイルアップロード | ○ | ○ | ○ | × | × |
| チャット実行 | ○ | ○ | ○ | ○ | × |
| 統計閲覧 | ○ | ○ | ○ | × | ○ |
| APIキー管理 | ○ | ○ | × | × | × |

#### 2.2.2 テナント分離
- すべてのデータに `tenant_id` を付与
- クエリ時に必ず `tenant_id` でフィルタリング
- Row Level Security（RLS）による自動分離（将来実装）

---

## 3. データ保護

### 3.1 暗号化

#### 3.1.1 転送時暗号化
- **プロトコル**: TLS 1.3
- **証明書**: 有効なSSL証明書
- **HSTS**: 有効化

#### 3.1.2 保存時暗号化
- **APIキー**: AES-256-GCMで暗号化
- **パスワード**: bcryptでハッシュ化（平文保存禁止）

### 3.2 データ分離

#### 3.2.1 テナント分離
- 論理分離（`tenant_id`による）
- 物理分離（将来実装: テナント毎に別データベース）

#### 3.2.2 データアクセス制御
- すべてのクエリでテナントIDをチェック
- リポジトリ層で自動的にフィルタリング

---

## 4. 入力検証・サニタイゼーション

### 4.1 バリデーション

#### 4.1.1 バックエンド
- **Pydantic**: スキーマ定義によるバリデーション
- **型チェック**: 型ヒントによる型安全性
- **カスタムバリデーター**: ビジネスルールの検証

#### 4.1.2 フロントエンド
- **Zod**: スキーマ定義によるバリデーション
- **リアルタイムバリデーション**: 入力中に検証

### 4.2 サニタイゼーション

#### 4.2.1 SQLインジェクション対策
- **ORM使用**: SQLAlchemyによるパラメータ化クエリ
- **直接SQL禁止**: 生のSQLクエリは使用しない

#### 4.2.2 XSS対策
- **入力サニタイゼーション**: HTMLタグのエスケープ
- **CSP**: Content Security Policyの設定
- **React**: 自動的にXSS対策

#### 4.2.3 CSRF対策
- **SameSite Cookie**: CookieのSameSite属性設定
- **CSRFトークン**: フレームワーク標準機能

---

## 5. セキュリティヘッダー

### 5.1 HTTPセキュリティヘッダー

```
Strict-Transport-Security: max-age=31536000; includeSubDomains
X-Content-Type-Options: nosniff
X-Frame-Options: DENY
X-XSS-Protection: 1; mode=block
Content-Security-Policy: default-src 'self'
Referrer-Policy: strict-origin-when-cross-origin
Permissions-Policy: geolocation=(), microphone=(), camera=()
```

---

## 6. ログ・監視

### 6.1 セキュリティログ

#### 6.1.1 記録対象
- ログイン試行（成功・失敗）
- 認証エラー
- 権限エラー
- 重要な操作（ユーザー作成、削除等）
- APIキーのアクセス

#### 6.1.2 ログ形式
```json
{
  "timestamp": "2025-01-01T00:00:00Z",
  "level": "SECURITY",
  "event": "login_attempt",
  "user_id": "uuid",
  "ip_address": "192.168.1.1",
  "user_agent": "Mozilla/5.0...",
  "success": false,
  "reason": "invalid_password"
}
```

### 6.2 監視・アラート

#### 6.2.1 監視項目
- 異常なログイン試行（レート制限超過）
- 権限エラーの頻発
- APIキーの不正アクセス
- データベースアクセスの異常

#### 6.2.2 アラート設定
- 5分間に10回以上のログイン失敗
- 1時間に100回以上の権限エラー
- 異常なIPアドレスからのアクセス

### 6.3 監査ログ

#### 6.3.1 記録方針
- **重要な操作**: ユーザーの明示的な操作（ログイン、データ作成・更新・削除など）は必ず記録
- **自動ポーリング**: システムの自動監視（ダッシュボードの自動更新など）による監査ログ取得は記録しない
  - 初回取得時のみ監査ログを記録し、自動ポーリング時は`skip_audit=true`パラメータで記録をスキップ
  - これにより、無駄な監査ログ記録を削減し、データベース領域を節約
 - **参照系GETの扱い**: ダッシュボード表示・一覧取得などの参照系GETは原則audit_logsの対象外とし、
   重要な変更操作およびセキュリティ／異常検知イベントを主な記録対象とする。

#### 6.3.2 記録対象アクション
- 認証関連: `login`, `logout`, `register`
- ユーザー管理: `create_user`, `update_user`, `delete_user`
- コンテンツ管理: `content_created`, `content_updated`, `content_deleted`, `file_processed`
- テナント管理: `tenant_created`, `tenant_updated`
- APIキー管理: `api_key_created`, `api_key_deleted`
- 監査ログ取得: `get_recent_audit_logs`（初回取得時のみ）

---

## 7. 脆弱性対策

### 7.1 OWASP Top 10対策

#### 7.1.1 インジェクション
- **SQLインジェクション**: ORM使用
- **コマンドインジェクション**: サブプロセス実行の制限

#### 7.1.2 認証の不備
- **パスワード強度**: バリデーション
- **セッション管理**: JWT使用
- **多要素認証**: 将来実装予定

#### 7.1.3 機密データの露出
- **APIキー**: 暗号化保存
- **パスワード**: ハッシュ化
- **ログ**: 機密情報を含めない

#### 7.1.4 XML外部エンティティ（XXE）
- XMLパーサーの無効化

#### 7.1.5 アクセス制御の不備
- **RBAC**: ロールベースアクセス制御
- **テナント分離**: データアクセス制御

#### 7.1.6 セキュリティ設定の不備
- **デフォルト設定**: セキュアなデフォルト値
- **エラーメッセージ**: 詳細情報を隠す

#### 7.1.7 XSS
- **入力サニタイゼーション**: HTMLエスケープ
- **CSP**: Content Security Policy

#### 7.1.8 安全でないデシリアライゼーション
- **JSON**: 信頼できるソースからのみ
- **バリデーション**: スキーマ検証

#### 7.1.9 既知の脆弱性のあるコンポーネント
- **依存関係管理**: 定期的な更新
- **脆弱性スキャン**: 自動スキャン（将来実装）

#### 7.1.10 ログ・監視の不備
- **構造化ログ**: JSON形式
- **監視**: メトリクス収集（将来実装）

---

## 8. 脅威分析

### 8.1 脅威モデル

#### 8.1.1 認証の侵害
- **脅威**: パスワードの推測、ブルートフォース攻撃
- **対策**: パスワード強度、レート制限、アカウントロック

#### 8.1.2 セッションのハイジャック
- **脅威**: トークンの盗難、XSS攻撃
- **対策**: HTTPS、HttpOnly Cookie、CSP

#### 8.1.3 データ漏洩
- **脅威**: SQLインジェクション、権限エスカレーション
- **対策**: ORM使用、テナント分離、アクセス制御

#### 8.1.4 DDoS攻撃
- **脅威**: 大量リクエストによるサービス停止
- **対策**: レート制限、CDN、ロードバランサー（将来実装）

---

## 9. インシデント対応

### 9.1 インシデント対応フロー

1. **検知**: ログ・監視による異常検知
2. **分析**: インシデントの影響範囲を分析
3. **対応**: 緊急対応（サービス停止、アクセス遮断等）
4. **復旧**: システムの復旧
5. **報告**: インシデントレポート作成
6. **改善**: 再発防止策の実装

### 9.2 エスカレーション

- **レベル1**: 通常のエラー（自動対応）
- **レベル2**: 中程度のインシデント（担当者対応）
- **レベル3**: 重大なインシデント（緊急対応チーム）

---

## 10. コンプライアンス

### 10.1 GDPR対応

- **データ主体の権利**: アクセス、削除、訂正
- **データ保持**: 必要最小限の期間
- **同意管理**: 明示的な同意取得

### 10.2 個人情報保護

- **個人情報の識別**: メールアドレス、IPアドレス等
- **暗号化**: 転送時・保存時の暗号化
- **アクセス制御**: 必要最小限のアクセス権限

---

## 11. セキュリティテスト

### 11.1 テスト項目

- **脆弱性スキャン**: 自動スキャン（将来実装）
- **ペネトレーションテスト**: 年1回実施（将来実装）
- **コードレビュー**: セキュリティ観点でのレビュー

### 11.2 チェックリスト

- [ ] 認証・認可が適切に実装されているか
- [ ] 入力バリデーションが実装されているか
- [ ] SQLインジェクション対策がされているか
- [ ] XSS対策がされているか
- [ ] CSRF対策がされているか
- [ ] 機密情報が暗号化されているか
- [ ] ログに機密情報が含まれていないか
- [ ] セキュリティヘッダーが設定されているか

---

**作成日**: 2025-01-XX  
**最終更新日**: 2025-01-XX

