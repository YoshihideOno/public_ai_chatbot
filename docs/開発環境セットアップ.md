# 開発環境セットアップガイド

本ドキュメントでは、RAG AIプラットフォームの開発環境を構築する手順を説明します。

## 目次

- [前提条件](#前提条件)
- [クイックスタート（Docker Compose）](#クイックスタートdocker-compose)
- [個別セットアップ](#個別セットアップ)
- [データベースマイグレーション](#データベースマイグレーション)
- [動作確認](#動作確認)
- [トラブルシューティング](#トラブルシューティング)

---

## 前提条件

以下のソフトウェアがインストールされている必要があります：

- **Docker** 20.10以上 & **Docker Compose** 2.0以上（推奨）
- **Node.js** 20.0以上（フロントエンド開発時）
- **Python** 3.11以上（バックエンド開発時）
- **Git** 2.0以上

### バージョン確認

```bash
# Docker
docker --version
docker compose version

# Node.js
node --version
npm --version

# Python
python3 --version
pip3 --version

# Git
git --version
```

---

## クイックスタート（Docker Compose）

最も簡単な方法は、Docker Composeを使用してすべてのサービスを一括起動することです。

### 1. リポジトリのクローン

```bash
git clone https://github.com/YOUR_ORG/ai_chatbot_project.git
cd ai_chatbot_project
```

### 2. 環境変数の設定

ルートディレクトリの `env.example` を `.env.local` にコピーします：

```bash
cp env.example .env.local
```

`.env.local` を編集して、必要な環境変数を設定します。詳細は [environment-variables.md](./environment-variables.md) を参照してください。

最低限、以下の変数を設定してください：

```bash
# データベース設定
ASYNC_DATABASE_URL=postgresql+asyncpg://user:password@db:5432/ai_chatbot_db
DATABASE_URL_SYNC=postgresql://user:password@db:5432/ai_chatbot_db
POSTGRES_USER=user
POSTGRES_PASSWORD=password
POSTGRES_DB=ai_chatbot_db

# JWT認証
SECRET_KEY=your-secret-key-change-in-production

# AI APIキー（任意、後で設定可能）
# OPENAI_API_KEY=sk-...
# ANTHROPIC_API_KEY=...

# ストレージ
# 未設定時は /tmp/rag_storage を自動利用します
STORAGE_LOCAL_PATH=/tmp/rag_storage
```

### 3. サービスの起動

```bash
docker compose up -d
```

このコマンドで以下のサービスが起動します：

- **frontend-admin**: Next.js管理画面（`http://localhost:3000`）
- **widget-cdn**: チャットウィジェット配信サーバー（`http://localhost:3001`）
- **fastapi**: FastAPIバックエンド（`http://localhost:8000`）
- **db**: PostgreSQL + pgvector（`localhost:5432`）

### 4. データベースマイグレーション

初回起動時は、データベースマイグレーションを実行する必要があります：

```bash
# FastAPIコンテナ内でマイグレーション実行
docker compose exec fastapi alembic upgrade head
```

> `DATABASE_URL_SYNC` が `.env.local` に設定されている場合は自動的に読み込まれます。Neonなどの外部DBを利用する場合は `postgresql://` 形式になっているかを確認してください。

### 5. ログの確認

各サービスのログを確認できます：

```bash
# すべてのサービスのログ
docker compose logs -f

# 特定のサービスのログ
docker compose logs -f fastapi
docker compose logs -f frontend-admin
docker compose logs -f db
```

### 6. サービスの停止

```bash
docker compose down
```

データボリュームも削除する場合：

```bash
docker compose down -v
```

---

## 個別セットアップ

Docker Composeを使用せず、各サービスを個別に起動する場合の手順です。

### 1. データベースの起動（Docker Compose）

データベースのみDocker Composeで起動します：

```bash
docker compose up -d db
```

### 2. バックエンド（FastAPI）のセットアップ

#### 2.1. 仮想環境の作成

```bash
cd api
python3 -m venv venv
source venv/bin/activate  # Windows: venv\Scripts\activate
```

#### 2.2. 依存関係のインストール

```bash
pip install -r requirements.txt
```

#### 2.3. 環境変数の設定

`api/.env` を作成し、以下の変数を設定します：

```bash
ASYNC_DATABASE_URL=postgresql+asyncpg://user:password@localhost:5432/ai_chatbot_db
DATABASE_URL_SYNC=postgresql://user:password@localhost:5432/ai_chatbot_db
SECRET_KEY=your-secret-key-change-in-production
ACCESS_TOKEN_EXPIRE_MINUTES=30
OPENAI_API_KEY=sk-...  # 任意
ANTHROPIC_API_KEY=...  # 任意
LOG_LEVEL=debug
```

#### 2.4. データベースマイグレーション

```bash
alembic upgrade head
```

#### 2.5. サーバーの起動

```bash
uvicorn main:app --reload --host 0.0.0.0 --port 8000
```

APIドキュメントは `http://localhost:8000/docs` で確認できます。

### 3. フロントエンド（Next.js）のセットアップ

#### 3.1. 依存関係のインストール

```bash
cd frontend
npm install
```

#### 3.2. 環境変数の設定

`frontend/.env.local` を作成し、以下の変数を設定します：

```bash
NEXT_PUBLIC_APP_NAME=AI Chatbot
NEXT_PUBLIC_API_BASE_URL=http://localhost:8000
FASTAPI_BASE_URL=http://localhost:8000
```

#### 3.3. 開発サーバーの起動

```bash
npm run dev
```

アプリケーションは `http://localhost:3000` で利用できます。

### 4. ウィジェットCDN（任意）のセットアップ

```bash
cd packages/widget
npm install
npm run build
npm run serve
```

ウィジェットは `http://localhost:3001` で配信されます。

---

## データベースマイグレーション

### マイグレーションの実行

```bash
cd api

# 最新バージョンにアップグレード
DATABASE_URL_SYNC=postgresql://user:password@localhost:5432/ai_chatbot_db alembic upgrade head

# 特定のリビジョンにアップグレード
DATABASE_URL_SYNC=postgresql://user:password@localhost:5432/ai_chatbot_db alembic upgrade <revision_id>

# 1つ前のバージョンにダウングレード
DATABASE_URL_SYNC=postgresql://user:password@localhost:5432/ai_chatbot_db alembic downgrade -1
```

### 新しいマイグレーションの作成

```bash
cd api

# 自動生成（モデル変更を検出）
DATABASE_URL_SYNC=postgresql://user:password@localhost:5432/ai_chatbot_db alembic revision --autogenerate -m "description"

# 手動作成
alembic revision -m "description"
```

### マイグレーション履歴の確認

```bash
alembic history
alembic current
```

---

## 動作確認

### 1. バックエンドの確認

```bash
# ヘルスチェック
curl http://localhost:8000/health

# OpenAPIドキュメント
# ブラウザで http://localhost:8000/docs を開く
```

### 2. フロントエンドの確認

```bash
# ブラウザで http://localhost:3000 を開く
# ログインページが表示されればOK
```

### 3. データベースの確認

```bash
# PostgreSQLに接続
docker compose exec db psql -U user -d ai_chatbot_db

# テーブル一覧を確認
\dt

# 拡張機能を確認
\dx
```

### 4. 初回ユーザー登録

1. フロントエンド（`http://localhost:3000`）にアクセス
2. 「新規登録」からユーザーを作成
3. ログインしてダッシュボードにアクセス

---

## トラブルシューティング

### ポートが既に使用されている

```bash
# ポート使用状況を確認
# Linux/Mac
lsof -i :8000
lsof -i :3000

# Windows
netstat -ano | findstr :8000
```

解決方法：
- 既存のプロセスを停止する
- `docker-compose.yml` でポート番号を変更する

### データベース接続エラー

```bash
# データベースコンテナの状態を確認
docker compose ps db

# データベースログを確認
docker compose logs db

# データベースを再起動
docker compose restart db
```

### マイグレーションエラー

```bash
# 現在のマイグレーション状態を確認
cd api
alembic current

# エラーが発生した場合、手動で修正が必要な場合があります
# 詳細はトラブルシューティングガイドを参照
```

### 依存関係のインストールエラー

**Python:**
```bash
# 仮想環境を再作成
cd api
rm -rf venv
python3 -m venv venv
source venv/bin/activate
pip install --upgrade pip
pip install -r requirements.txt
```

**Node.js:**
```bash
# node_modulesを削除して再インストール
cd frontend
rm -rf node_modules package-lock.json
npm install
```

### Docker Composeのビルドエラー

```bash
# イメージを再ビルド
docker compose build --no-cache

# 特定のサービスのみ再ビルド
docker compose build --no-cache fastapi
```

### 環境変数が読み込まれない

- `.env.local` が正しい場所にあるか確認
- 環境変数名にタイポがないか確認
- Docker Composeを使用している場合、`env_file` の設定を確認

---

## 次のステップ

開発環境のセットアップが完了したら、以下を参照してください：

- [開発ガイド](./development-guide.md) - コーディング規約と開発フロー
- [APIリファレンス](./api-reference.md) - APIエンドポイントの詳細
- [環境変数リファレンス](./environment-variables.md) - 全環境変数の説明

---

**最終更新日**: 2025-01-XX

