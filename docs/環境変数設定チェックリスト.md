# 環境変数設定チェックリスト

本ドキュメントでは、開発環境と本番環境で必要な環境変数の設定を確認するためのチェックリストを提供します。

## 目次

- [開発環境](#開発環境)
- [本番環境（Vercel）](#本番環境vercel)
- [本番環境（Railway）](#本番環境railway)
- [ウィジェット関連の環境変数設定手順](#ウィジェット関連の環境変数設定手順)
- [設定確認方法](#設定確認方法)

---

## 開発環境

### フロントエンド（`frontend/.env.local`）

- [ ] `NEXT_PUBLIC_API_URL=http://localhost:8000/api/v1`
- [ ] `NEXT_PUBLIC_WIDGET_CDN_URL=http://localhost:3001/widget.js`（任意、ローカルウィジェットを使用する場合）
- [ ] `NEXT_PUBLIC_WIDGET_TENANT_ID`（任意、ウィジェットを埋め込む場合）
- [ ] `NEXT_PUBLIC_WIDGET_API_KEY`（任意、ウィジェットを埋め込む場合）

### バックエンド（`api/.env` または `.env.local`）

- [ ] `DATABASE_URL` または `ASYNC_DATABASE_URL`
- [ ] `DATABASE_URL_SYNC`（Alembic用）
- [ ] `SECRET_KEY`（開発用の値で可）
- [ ] `WIDGET_CDN_URL=http://localhost:3001/widget.js`（任意、埋め込みコード生成時に使用）
- [ ] `API_BASE_URL=http://localhost:8000/api/v1`（任意、埋め込みコード生成時に使用）
- [ ] `APP_URL=http://localhost:3000`（任意、埋め込みコード生成時に使用）

---

## 本番環境（Vercel）

### フロントエンド環境変数

Vercel Dashboard → Settings → Environment Variables で以下を設定：

- [ ] `NODE_ENV=production`
- [ ] `NEXT_PUBLIC_APP_NAME=AI Chatbot`
- [ ] `NEXT_PUBLIC_APP_VERSION=1.0.0`
- [ ] `NEXT_PUBLIC_API_BASE_URL=https://your-api-url.com`
- [ ] `NEXT_PUBLIC_API_URL=https://your-api-url.com/api/v1`（**重要**: 埋め込みコード生成時に使用）
- [ ] `NEXT_PUBLIC_WIDGET_CDN_URL=https://your-widget-cdn-url.com/widget.js`（**重要**: 埋め込みコード生成時に使用）

### ウィジェット環境変数（ウィジェット専用プロジェクト）

- [ ] `NODE_ENV=production`

---

## 本番環境（Railway）

### バックエンド環境変数

Railway Dashboard → Variables で以下を設定：

#### 必須環境変数

- [ ] `DATABASE_URL` または `ASYNC_DATABASE_URL`
- [ ] `DATABASE_URL_SYNC`
- [ ] `SECRET_KEY`（強力なランダム文字列、32文字以上）
- [ ] `ENVIRONMENT=production`
- [ ] `DEBUG=false`
- [ ] `APP_URL=https://your-app-url.com`

#### 推奨環境変数（埋め込みコード生成用）

- [ ] `WIDGET_CDN_URL=https://your-widget-cdn-url.com/widget.js`（**推奨**: 埋め込みコード生成時に使用）
- [ ] `API_BASE_URL=https://your-api-url.com/api/v1`（**推奨**: 埋め込みコード生成時に使用）

**注意**: `WIDGET_CDN_URL` と `API_BASE_URL` が未設定の場合、デフォルト値または `APP_URL` から自動構築されますが、本番環境では適切な値を設定することを強く推奨します。

#### その他の環境変数

- [ ] `OPENAI_API_KEY`（AI API使用時）
- [ ] `ANTHROPIC_API_KEY`（AI API使用時）
- [ ] `STRIPE_SECRET_KEY`（課金機能使用時）
- [ ] `STRIPE_WEBHOOK_SECRET`（課金機能使用時）
- [ ] `RESEND_API_KEY`（メール送信機能使用時）
- [ ] `BLOB_READ_WRITE_TOKEN`（Vercel Blob Storage使用時）

---

## ウィジェット関連の環境変数設定手順

### 1. ウィジェットCDN URLの取得

ウィジェットをデプロイした後、以下のURLを取得します：

- Vercel: `https://your-widget-project.vercel.app/widget.js`
- その他のCDN: `https://your-cdn-domain.com/widget.js`

### 2. フロントエンド（Vercel）での設定

1. Vercel Dashboard → プロジェクト → Settings → Environment Variables
2. 以下の環境変数を追加：
   - `NEXT_PUBLIC_WIDGET_CDN_URL`: ウィジェットCDN URL
   - `NEXT_PUBLIC_API_URL`: APIベースURL（例: `https://api.example.com/api/v1`）

### 3. バックエンド（Railway）での設定

1. Railway Dashboard → プロジェクト → Variables
2. 以下の環境変数を追加：
   - `WIDGET_CDN_URL`: ウィジェットCDN URL
   - `API_BASE_URL`: APIベースURL（例: `https://api.example.com/api/v1`）

**注意**: `API_BASE_URL` が未設定の場合、`APP_URL` から自動構築されます（`APP_URL/api/v1`）。

---

## 設定確認方法

### フロントエンド（Vercel）

1. Vercel Dashboard → プロジェクト → Settings → Environment Variables
2. 環境変数が正しく設定されているか確認
3. デプロイ後にブラウザの開発者ツールで `process.env.NEXT_PUBLIC_*` の値を確認

### バックエンド（Railway）

1. Railway Dashboard → プロジェクト → Variables
2. 環境変数が正しく設定されているか確認
3. アプリケーションログで設定バリデーションの警告を確認

### 埋め込みコードの確認

1. ダッシュボードにログイン
2. 「テナント設定」ページを開く
3. 「埋め込みコード」セクションで生成されたコードを確認
4. 生成されたコードに正しいURLが含まれているか確認

### ログでの確認

バックエンドの起動ログで以下の警告が表示されていないか確認：

```
WARNING: WIDGET_CDN_URLが設定されていません。埋め込みコード生成時にデフォルト値が使用されます。
WARNING: API_BASE_URLまたはAPP_URLが設定されていません。埋め込みコード生成時に相対パスが使用されます。
```

これらの警告が表示される場合は、適切な環境変数を設定してください。

---

## トラブルシューティング

### 埋め込みコードにデフォルトURLが含まれている

**原因**: `WIDGET_CDN_URL` または `API_BASE_URL` が未設定

**解決方法**: 
- Railway Dashboardで `WIDGET_CDN_URL` と `API_BASE_URL` を設定
- Vercel Dashboardで `NEXT_PUBLIC_WIDGET_CDN_URL` と `NEXT_PUBLIC_API_URL` を設定

### 埋め込みコードが動作しない

**確認項目**:
1. ウィジェットCDN URLが正しく設定されているか
2. API URLが正しく設定されているか
3. CORS設定が適切か（バックエンドの `BACKEND_CORS_ORIGINS` が `*` など十分に広い設定になっているか）
4. テナントIDとAPIキーが正しく設定されているか（ウィジェット用キーは公開前提であり、設置ドメインはテナント設定画面の「設置ドメイン」に登録されているか）

### 環境変数が反映されない

**確認項目**:
1. 環境変数の名前が正しいか（タイポがないか）
2. 環境変数が正しい環境（Production/Preview/Development）に設定されているか
3. アプリケーションを再デプロイしたか（環境変数の変更後は再デプロイが必要）

---

## 関連ドキュメント

- [環境変数リファレンス](./環境変数リファレンス.md)
- [デプロイガイド](./デプロイガイド.md)
- [トラブルシューティング](./トラブルシューティング.md)

