name: AWS CI/CD Pipeline Migration

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  # 既存のテストジョブ（AWS移行後も維持）
  test:
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:13-alpine
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: ai_chatbot_app/package-lock.json
    
    - name: Install dependencies
      run: |
        cd ai_chatbot_app
        npm ci
    
    - name: Run TypeScript check
      run: |
        cd ai_chatbot_app
        npx tsc --noEmit
    
    - name: Run linting
      run: |
        cd ai_chatbot_app
        npm run lint || echo "Linting not configured yet"
    
    - name: Build application
      run: |
        cd ai_chatbot_app
        npm run build
      env:
        DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test_db

  # AWS CodePipeline トリガー（移行用）
  trigger-aws-pipeline:
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ secrets.AWS_REGION }}
    
    - name: Trigger AWS CodePipeline
      run: |
        # 環境を決定
        if [ "${{ github.ref }}" = "refs/heads/main" ]; then
          ENVIRONMENT="prod"
        else
          ENVIRONMENT="dev"
        fi
        
        PIPELINE_NAME="${ENVIRONMENT}-ai-chatbot-pipeline"
        
        echo "Triggering AWS CodePipeline: $PIPELINE_NAME"
        aws codepipeline start-pipeline-execution --name $PIPELINE_NAME
        
        echo "Pipeline execution started successfully"
    
    - name: Wait for pipeline completion
      run: |
        # 環境を決定
        if [ "${{ github.ref }}" = "refs/heads/main" ]; then
          ENVIRONMENT="prod"
        else
          ENVIRONMENT="dev"
        fi
        
        PIPELINE_NAME="${ENVIRONMENT}-ai-chatbot-pipeline"
        
        echo "Waiting for pipeline completion..."
        
        # パイプラインの実行状況を監視
        while true; do
          STATUS=$(aws codepipeline get-pipeline-execution \
            --pipeline-name $PIPELINE_NAME \
            --pipeline-execution-id $(aws codepipeline list-pipeline-executions \
              --pipeline-name $PIPELINE_NAME \
              --query 'pipelineExecutionSummaries[0].pipelineExecutionId' \
              --output text) \
            --query 'pipelineExecution.status' \
            --output text)
          
          echo "Pipeline status: $STATUS"
          
          if [ "$STATUS" = "Succeeded" ]; then
            echo "Pipeline completed successfully!"
            break
          elif [ "$STATUS" = "Failed" ] || [ "$STATUS" = "Stopped" ]; then
            echo "Pipeline failed or stopped!"
            exit 1
          fi
          
          sleep 30
        done

  # AWS ECR へのイメージプッシュ（代替デプロイ方法）
  deploy-to-aws:
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ secrets.AWS_REGION }}
    
    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2
    
    - name: Build, tag, and push image to Amazon ECR
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        ECR_REPOSITORY: ${{ secrets.ECR_REPOSITORY }}
        IMAGE_TAG: ${{ github.sha }}
      run: |
        # 環境を決定
        if [ "${{ github.ref }}" = "refs/heads/main" ]; then
          ENVIRONMENT="prod"
        else
          ENVIRONMENT="dev"
        fi
        
        ECR_REPOSITORY="${ENVIRONMENT}-ai-chatbot-app"
        
        # Dockerイメージをビルド
        cd ai_chatbot_app
        docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
        docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:latest
        
        # ECRにプッシュ
        docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
        docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest
        
        echo "Image pushed to ECR: $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG"
    
    - name: Update ECS service
      run: |
        # 環境を決定
        if [ "${{ github.ref }}" = "refs/heads/main" ]; then
          ENVIRONMENT="prod"
        else
          ENVIRONMENT="dev"
        fi
        
        CLUSTER_NAME="${ENVIRONMENT}-ai-chatbot-cluster"
        SERVICE_NAME="${ENVIRONMENT}-ai-chatbot-service"
        
        echo "Updating ECS service: $SERVICE_NAME"
        
        # ECSサービスを更新
        aws ecs update-service \
          --cluster $CLUSTER_NAME \
          --service $SERVICE_NAME \
          --force-new-deployment
        
        echo "ECS service update initiated"
    
    - name: Wait for deployment completion
      run: |
        # 環境を決定
        if [ "${{ github.ref }}" = "refs/heads/main" ]; then
          ENVIRONMENT="prod"
        else
          ENVIRONMENT="dev"
        fi
        
        CLUSTER_NAME="${ENVIRONMENT}-ai-chatbot-cluster"
        SERVICE_NAME="${ENVIRONMENT}-ai-chatbot-service"
        
        echo "Waiting for deployment completion..."
        
        # デプロイメントの完了を待機
        aws ecs wait services-stable \
          --cluster $CLUSTER_NAME \
          --services $SERVICE_NAME
        
        echo "Deployment completed successfully!"

  # 通知ジョブ
  notify:
    runs-on: ubuntu-latest
    needs: [test, trigger-aws-pipeline, deploy-to-aws]
    if: always()
    
    steps:
    - name: Notify deployment status
      run: |
        if [ "${{ needs.test.result }}" = "success" ] && [ "${{ needs.deploy-to-aws.result }}" = "success" ]; then
          echo "✅ Deployment successful!"
          echo "Environment: ${{ github.ref == 'refs/heads/main' && 'production' || 'development' }}"
          echo "Commit: ${{ github.sha }}"
        else
          echo "❌ Deployment failed!"
          echo "Test result: ${{ needs.test.result }}"
          echo "Deploy result: ${{ needs.deploy-to-aws.result }}"
        fi

